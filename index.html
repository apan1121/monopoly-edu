<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Primary Meta Tags -->
<title>ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ² | å¯“æ•™æ–¼æ¨‚</title>
<meta name="title" content="ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ² | å¯“æ•™æ–¼æ¨‚">
<meta name="description" content="å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œå« 3D éª°å­ã€ä»»å‹™ç³»çµ±ã€è¿·éœ§æ¨¡å¼ã€‚é©ç”¨æ–¼é«”è‚²ã€è‹±æ–‡ã€æ•¸å­¸ç­‰å„ç§‘æ•™å­¸ï¼Œè®“å­¸ç”Ÿé€ééŠæˆ²å®ŒæˆçœŸå¯¦å­¸ç¿’ä»»å‹™ï¼">
<meta name="keywords" content="å¤§å¯Œç¿éŠæˆ²,æ•™å­¸éŠæˆ²,èª²å ‚éŠæˆ²,äº’å‹•éŠæˆ²,æ•™è‚²éŠæˆ²,æ¡ŒéŠ,å­¸ç¿’éŠæˆ²,ä»»å‹™éŠæˆ²,éª°å­éŠæˆ²,å…è²»éŠæˆ²">
<meta name="author" content="Educational Game Project">
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://your-domain.com/">
<meta property="og:title" content="ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ²">
<meta property="og:description" content="å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œè®“å­¸ç¿’è®Šå¾—æ›´æœ‰è¶£ï¼">
<meta property="og:image" content="https://your-domain.com/preview.png">
<meta property="og:site_name" content="å¤§å¯Œç¿æ•™å­¸éŠæˆ²">
<meta property="og:locale" content="zh_TW">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://your-domain.com/">
<meta property="twitter:title" content="ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ²">
<meta property="twitter:description" content="å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œè®“å­¸ç¿’è®Šå¾—æ›´æœ‰è¶£ï¼">
<meta property="twitter:image" content="https://your-domain.com/preview.png">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ²</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ²</text></svg>">

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å¤§å¯Œç¿éŠæˆ²">

<!-- Structured Data / JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "å¤§å¯Œç¿æ•™å­¸éŠæˆ²",
  "description": "å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œå« 3D éª°å­ã€ä»»å‹™ç³»çµ±ã€è¿·éœ§æ¨¡å¼",
  "url": "https://your-domain.com/",
  "applicationCategory": "EducationalApplication",
  "operatingSystem": "Web Browser",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "TWD"
  },
  "author": {
    "@type": "Organization",
    "name": "Educational Game Project"
  },
  "inLanguage": "zh-TW",
  "browserRequirements": "Requires JavaScript. Requires HTML5.",
  "softwareVersion": "1.0",
  "releaseNotes": "åˆç‰ˆç™¼å¸ƒ",
  "featureList": [
    "3D éª°å­å‹•ç•«",
    "è‡ªè¨‚ä»»å‹™ç³»çµ±",
    "2-6 äººå¤šäººéŠæˆ²",
    "è¿·éœ§æ¢ç´¢æ¨¡å¼",
    "éŸ¿æ‡‰å¼è¨­è¨ˆ",
    "è¨­å®šåŒ¯å…¥åŒ¯å‡º",
    "å³æ™‚è¨ˆåˆ†ç³»çµ±"
  ]
}
</script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    min-height: 100vh;
    padding: 20px;
    overflow-x: hidden;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  h1 {
    text-align: center;
    color: white;
    font-size: 3em;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    margin-bottom: 30px;
    animation: titleBounce 2s ease-in-out infinite;
  }

  @keyframes titleBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* ========== è¨­å®šé é¢ ========== */
  #setupPage {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 800px;
    margin: 0 auto;
  }

  .setup-section {
    margin-bottom: 30px;
  }

  .setup-section h2 {
    color: #667eea;
    margin-bottom: 15px;
    font-size: 1.5em;
  }

  .input-group {
    margin-bottom: 15px;
  }

  .input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
  }

  .input-group input,
  .input-group textarea {
    width: 100%;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    transition: border-color 0.3s;
  }

  .input-group input:focus,
  .input-group textarea:focus {
    outline: none;
    border-color: #667eea;
  }

  .input-group textarea {
    resize: vertical;
    min-height: 80px;
    font-family: inherit;
  }

  .player-input {
    display: grid;
    grid-template-columns: 40px 1fr;
    gap: 10px;
    align-items: start;
    margin-bottom: 15px;
  }

  .player-color {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: transform 0.2s;
  }

  .player-color:hover {
    transform: scale(1.1);
  }

  .player-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .color-picker {
    display: none;
    grid-template-columns: repeat(10, 28px);
    gap: 5px;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 8px;
    margin-top: 5px;
  }

  .color-picker.active {
    display: grid;
  }

  .color-option {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
  }

  .color-option:hover {
    transform: scale(1.15);
    border-color: #999;
  }

  .color-option.selected {
    border-color: #333;
    border-width: 3px;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
  }

  .task-item {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid #667eea;
  }

  .task-item textarea {
    width: 100%;
    margin-top: 5px;
  }

  .btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 50px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 14px;
  }

  .btn-success {
    background: linear-gradient(135deg, #11998e, #38ef7d);
  }

  .btn-danger {
    background: linear-gradient(135deg, #eb3349, #f45c43);
  }

  /* ========== éŠæˆ²é é¢ ========== */
  #gamePage {
    display: none;
  }

  .game-header {
    background: white;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  }

  .game-main {
    position: relative;
  }

  /* æµ®å‹•æ§åˆ¶æŒ‰éˆ• */
  .floating-button {
    position: fixed;
    right: 30px;
    bottom: 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    font-size: 32px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 999;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .floating-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
  }

  .floating-button.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .players-info-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .player-card {
    background: linear-gradient(135deg, #f5f7fa, #e8eef5);
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .player-card.active {
    border-color: #ffd700;
    background: linear-gradient(135deg, #fff8dc, #fffacd);
    box-shadow: 0 3px 12px rgba(255, 215, 0, 0.4);
    transform: translateX(5px);
  }

  .player-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .player-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid white;
    flex-shrink: 0;
  }

  .player-name {
    font-weight: bold;
    font-size: 0.95em;
    color: #333;
  }

  .player-score {
    font-size: 1.1em;
    font-weight: bold;
    color: #667eea;
    white-space: nowrap;
  }

  /* ========== æ£‹ç›¤ ========== */
  #boardContainer {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 1200px;
    margin: 0 auto;
  }

  #board {
    display: grid;
    gap: 8px;
    max-width: 100%;
    margin: 0 auto;
    justify-items: stretch;
  }

  /* è™•ç†è›‡å½¢æ’åˆ—æ™‚ä¸å®Œæ•´è¡Œçš„å°é½Š */
  .cell.align-right {
    grid-column-start: auto;
  }

  .cell {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #e0e7ff, #cfe2ff);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 8px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    position: relative;
    font-size: 0.85em;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 3px solid transparent;
  }

  .cell:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.25);
  }

  .cell.start {
    background: linear-gradient(135deg, #56ab2f, #a8e063);
    font-weight: bold;
    font-size: 1.1em;
    color: white;
  }

  .cell.finish {
    background: linear-gradient(135deg, #ff6b6b, #feca57);
    font-weight: bold;
    font-size: 1.1em;
    color: white;
  }

  .cell.has-task {
    background: linear-gradient(135deg, #ffd89b, #19547b);
    color: white;
    font-weight: 500;
  }

  .cell.current {
    border-color: #ffd700;
    animation: cellGlow 1s ease-in-out infinite;
  }

  @keyframes cellGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
  }

  /* è¿·éœ§é®è“‹æ•ˆæœ */
  .cell.fog-covered {
    position: relative;
    overflow: hidden;
  }

  .cell.fog-covered::before {
    content: '?';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(150, 150, 150, 0.95), rgba(100, 100, 100, 0.95));
    backdrop-filter: blur(3px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5em;
    color: rgba(255, 255, 255, 0.8);
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    z-index: 10;
    animation: fogPulse 2s ease-in-out infinite;
  }

  @keyframes fogPulse {
    0%, 100% { opacity: 0.95; }
    50% { opacity: 0.85; }
  }

  .cell.fog-covered .cell-number,
  .cell.fog-covered > div:not(.cell-players) {
    visibility: hidden;
  }

  .cell-number {
    position: absolute;
    top: 3px;
    left: 6px;
    font-size: 0.7em;
    font-weight: bold;
    background: rgba(255,255,255,0.7);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cell-players {
    position: absolute;
    bottom: 5px;
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90%;
  }

  .player-token {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    animation: tokenBounce 0.5s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }

  @keyframes tokenBounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* ========== éª°å­æ§åˆ¶å´é‚Šæ¬„ ========== */
  .dice-control {
    position: fixed;
    right: -320px;
    top: 0;
    width: 300px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 20px rgba(0,0,0,0.3);
    transition: right 0.3s ease-in-out;
    z-index: 998;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .dice-control.open {
    right: 0;
  }

  .dice-control-fixed {
    flex-shrink: 0;
    padding: 20px;
    padding-bottom: 10px;
  }

  .dice-control-scrollable {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px 20px;
  }

  .dice-control-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .close-sidebar {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 5px;
    line-height: 1;
  }

  .close-sidebar:hover {
    color: #333;
  }

  /* é®ç½©å±¤ */
  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 997;
  }

  .sidebar-overlay.active {
    opacity: 1;
    visibility: visible;
  }


  #diceDisplay {
    perspective: 1000px;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    cursor: pointer;
    transition: transform 0.2s;
  }

  #diceDisplay:hover:not(.disabled) {
    transform: scale(1.05);
  }

  #diceDisplay.disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .dice-3d {
    width: 100px;
    height: 100px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.1s;
    pointer-events: none;
  }

  .dice-3d.rolling {
    animation: diceRoll 0.6s ease-out;
  }

  @keyframes diceRoll {
    0% { transform: rotateX(0deg) rotateY(0deg); }
    25% { transform: rotateX(180deg) rotateY(180deg); }
    50% { transform: rotateX(360deg) rotateY(360deg); }
    75% { transform: rotateX(540deg) rotateY(540deg); }
    100% { transform: rotateX(720deg) rotateY(720deg); }
  }

  .dice-face {
    position: absolute;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #ffffff, #f0f0f0);
    border: 2px solid #333;
    border-radius: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    padding: 10px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
  }

  .dice-dot {
    width: 18px;
    height: 18px;
    background: #333;
    border-radius: 50%;
    box-shadow: inset 0 2px 3px rgba(0,0,0,0.3);
  }

  /* éª°å­å„é¢çš„ä½ç½® */
  .dice-face.front  { transform: translateZ(50px); }
  .dice-face.back   { transform: rotateY(180deg) translateZ(50px); }
  .dice-face.right  { transform: rotateY(90deg) translateZ(50px); }
  .dice-face.left   { transform: rotateY(-90deg) translateZ(50px); }
  .dice-face.top    { transform: rotateX(90deg) translateZ(50px); }
  .dice-face.bottom { transform: rotateX(-90deg) translateZ(50px); }

  /* å„é¢é»æ•¸çš„ä½ˆå±€ */
  .dice-face.face-1 {
    justify-content: center;
    align-items: center;
  }

  .dice-face.face-2 {
    display: grid;
    grid-template-areas:
      "a . ."
      ". . ."
      ". . b";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-2 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-2 .dice-dot:nth-child(2) { grid-area: b; }

  .dice-face.face-3 {
    display: grid;
    grid-template-areas:
      "a . ."
      ". b ."
      ". . c";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-3 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-3 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-3 .dice-dot:nth-child(3) { grid-area: c; }

  .dice-face.face-4 {
    display: grid;
    grid-template-areas:
      "a . b"
      ". . ."
      "c . d";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-4 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-4 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-4 .dice-dot:nth-child(3) { grid-area: c; }
  .dice-face.face-4 .dice-dot:nth-child(4) { grid-area: d; }

  .dice-face.face-5 {
    display: grid;
    grid-template-areas:
      "a . b"
      ". c ."
      "d . e";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-5 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-5 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-5 .dice-dot:nth-child(3) { grid-area: c; }
  .dice-face.face-5 .dice-dot:nth-child(4) { grid-area: d; }
  .dice-face.face-5 .dice-dot:nth-child(5) { grid-area: e; }

  .dice-face.face-6 {
    display: grid;
    grid-template-areas:
      "a . b"
      "c . d"
      "e . f";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-6 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-6 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-6 .dice-dot:nth-child(3) { grid-area: c; }
  .dice-face.face-6 .dice-dot:nth-child(4) { grid-area: d; }
  .dice-face.face-6 .dice-dot:nth-child(5) { grid-area: e; }
  .dice-face.face-6 .dice-dot:nth-child(6) { grid-area: f; }

  /* ========== ä»»å‹™å½ˆçª— ========== */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s;
  }

  .modal.active {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    animation: slideUp 0.4s ease-out;
  }

  @keyframes slideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    font-size: 2em;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 20px;
    text-align: center;
  }

  .modal-body {
    font-size: 1.3em;
    line-height: 1.6;
    color: #333;
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 5px solid #667eea;
  }

  .modal-footer {
    display: flex;
    gap: 15px;
    justify-content: center;
  }

  /* ========== çµæœé é¢ ========== */
  #resultPage {
    display: none;
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 800px;
    margin: 0 auto;
  }

  .result-title {
    text-align: center;
    font-size: 2.5em;
    color: #667eea;
    margin-bottom: 30px;
  }

  .winner {
    text-align: center;
    font-size: 3em;
    color: #ffd700;
    margin-bottom: 30px;
    animation: winnerShake 1s ease-in-out infinite;
  }

  @keyframes winnerShake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-5deg); }
    75% { transform: rotate(5deg); }
  }

  .scoreboard {
    margin-bottom: 30px;
  }

  .score-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 15px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .score-item.rank1 {
    background: linear-gradient(135deg, #ffd89b, #ff9a56);
    transform: scale(1.05);
  }

  .score-item.rank2 {
    background: linear-gradient(135deg, #dfe9f3, #b8c6db);
  }

  .score-item.rank3 {
    background: linear-gradient(135deg, #f5d0a9, #d7b899);
  }

  .score-rank {
    font-size: 2em;
    font-weight: bold;
    margin-right: 20px;
  }

  .score-player {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
  }

  .score-player-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid white;
  }

  .score-player-name {
    font-size: 1.5em;
    font-weight: bold;
  }

  .score-points {
    font-size: 2em;
    font-weight: bold;
    color: #667eea;
  }

  /* ========== éŸ¿æ‡‰å¼è¨­è¨ˆ ========== */
  @media (max-width: 768px) {
    h1 { font-size: 2em; }
    .player-card { padding: 10px 15px; }
    .modal-content { padding: 20px; }

    .floating-button {
      width: 60px;
      height: 60px;
      font-size: 28px;
      right: 20px;
      bottom: 20px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ²</h1>

  <!-- ========== è¨­å®šé é¢ ========== -->
  <div id="setupPage">
    <!-- åŸºæœ¬è¨­å®š -->
    <div class="setup-section">
      <h2>ğŸ“‹ åŸºæœ¬è¨­å®š</h2>
      <div class="input-group">
        <label>æ£‹ç›¤æ ¼å­æ•¸é‡ (å»ºè­° 20-50 æ ¼)</label>
        <input type="number" id="cellCount" min="20" max="50" value="30">
      </div>
      <div class="input-group">
        <label>ç©å®¶æ•¸é‡ (2-6 äºº)</label>
        <input type="number" id="playerCount" min="2" max="6" value="4">
      </div>
      <button class="btn btn-small" onclick="generatePlayerInputs()">ç”¢ç”Ÿç©å®¶è¨­å®šæ¬„ä½</button>
    </div>

    <!-- ç©å®¶è¨­å®š -->
    <div class="setup-section">
      <h2>ğŸ‘¥ ç©å®¶è¨­å®š</h2>
      <div id="playersInputs"></div>
    </div>

    <!-- ä»»å‹™è¨­å®š -->
    <div class="setup-section">
      <h2>ğŸ“ ä»»å‹™è¨­å®š</h2>
      <div class="input-group">
        <label>ä»»å‹™æ•¸é‡ (å»ºè­° 5-15 å€‹)</label>
        <input type="number" id="taskCount" min="1" max="20" value="8">
      </div>
      <div class="input-group">
        <label>ä»»å‹™æˆåŠŸç²å¾—åˆ†æ•¸</label>
        <input type="number" id="taskSuccessScore" min="1" max="100" value="10">
      </div>
      <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="hiddenMode" style="width: auto; margin: 0;">
        <label style="margin: 0; cursor: pointer;" for="hiddenMode">å•Ÿç”¨éš±è—æ¨¡å¼ï¼ˆæ ¼å­åœ¨ç©å®¶èµ°éå‰ç‚ºè¿·éœ§é®è“‹ï¼‰</label>
      </div>
      <button class="btn btn-small" onclick="generateTaskInputs()">ç”¢ç”Ÿä»»å‹™è¼¸å…¥æ¬„ä½</button>
      <div id="tasksInputs" style="margin-top: 15px;"></div>
    </div>

    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
      <button class="btn" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
      <button class="btn btn-small" onclick="exportSettings()" style="background: linear-gradient(135deg, #11998e, #38ef7d);">ğŸ“¤ åŒ¯å‡ºè¨­å®š</button>
      <button class="btn btn-small" onclick="document.getElementById('importFile').click()" style="background: linear-gradient(135deg, #eb3349, #f45c43);">ğŸ“¥ åŒ¯å…¥è¨­å®š</button>
      <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSettings(event)">
    </div>
  </div>

  <!-- ========== éŠæˆ²é é¢ ========== -->
  <div id="gamePage">
    <!-- æµ®å‹•æŒ‰éˆ• -->
    <button class="floating-button" onclick="toggleSidebar()">ğŸ²</button>

    <!-- é®ç½©å±¤ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»è¦éŠæˆ²å€ -->
    <div class="game-main">
      <!-- æ£‹ç›¤ -->
      <div id="boardContainer">
        <div id="board"></div>
      </div>

      <!-- éª°å­æ§åˆ¶å´é‚Šæ¬„ -->
      <div class="dice-control" id="diceControlSidebar">
        <!-- å›ºå®šå€åŸŸï¼šéª°å­ -->
        <div class="dice-control-fixed">
          <div class="dice-control-header">
            <h3 style="margin: 0; color: #667eea;">éŠæˆ²æ§åˆ¶</h3>
            <button class="close-sidebar" onclick="toggleSidebar()">âœ•</button>
          </div>

          <div id="diceDisplay" onclick="rollDice()"></div>
          <div style="text-align: center; color: #999; font-size: 0.9em; margin-top: -5px;">é»æ“Šéª°å­æ“²éª°</div>
          <div id="turnInfo" style="margin-top: 15px; font-size: 1em; font-weight: bold; line-height: 1.5; text-align: center;"></div>

          <div style="border-top: 2px solid #e0e0e0; margin: 20px 0;"></div>
          <h3 style="margin: 0 0 15px 0; color: #667eea;">ç©å®¶ç‹€æ…‹</h3>
        </div>

        <!-- å¯æ»¾å‹•å€åŸŸï¼šç©å®¶ç‹€æ…‹ -->
        <div class="dice-control-scrollable">
          <div class="players-info-compact" id="playersInfo"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ä»»å‹™å½ˆçª— ========== -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ¯ ä»»å‹™æŒ‘æˆ°</div>
      <div class="modal-body" id="taskText"></div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="completeTask(true)">âœ… å®Œæˆ</button>
        <button class="btn btn-danger" onclick="completeTask(false)">âŒ å¤±æ•—</button>
      </div>
    </div>
  </div>

  <!-- ========== çµæœé é¢ ========== -->
  <div id="resultPage">
    <div class="result-title">ğŸ† éŠæˆ²çµæŸ</div>
    <div class="winner" id="winnerText"></div>
    <div class="scoreboard" id="scoreboard"></div>
    <div style="text-align: center;">
      <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
  </div>
</div>

<script>
// ========== éŠæˆ²ç‹€æ…‹ ==========
let gameConfig = {
  cellCount: 30,
  playerCount: 4,
  taskSuccessScore: 10,
  tasks: [],
  hiddenMode: false
};

let players = [];
let currentPlayerIndex = 0;
let board = [];
let isRolling = false;
let visitedCells = new Set(); // è¿½è¹¤å·²è¨ªå•éçš„æ ¼å­
let diceStats = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}; // éª°å­çµ±è¨ˆ

// ========== é¡è‰²é…ç½® ==========
const PLAYER_COLORS = [
  '#E53935', // æ·±ç´…è‰²
  '#1976D2', // æ·±è—è‰²
  '#388E3C', // æ·±ç¶ è‰²
  '#F57C00', // æ·±æ©˜è‰²
  '#7B1FA2', // æ·±ç´«è‰²
  '#0097A7', // æ·±é’è‰²
  '#FF1744', // é®®ç´…è‰²
  '#F50057', // ç«ç‘°ç´…
  '#D500F9', // ç´«ç´…è‰²
  '#651FFF', // æ·±ç´«è‰²
  '#3D5AFE', // é›è—è‰²
  '#2979FF', // è—è‰²
  '#00B0FF', // æ·ºè—è‰²
  '#00E5FF', // é’è‰²
  '#1DE9B6', // ç¿ ç¶ è‰²
  '#00E676', // ç¶ è‰²
  '#76FF03', // äº®ç¶ è‰²
  '#C6FF00', // æª¸æª¬ç¶ 
  '#FFEA00', // é»ƒè‰²
  '#FFC400', // ç¥ç€è‰²
  '#FF9100', // æ©˜è‰²
  '#FF3D00', // æ·±æ©˜è‰²
  '#DD2C00', // æš—ç´…è‰²
  '#FF6E40', // æ·ºæ©˜è‰²
  '#FF5252', // ç´…è‰²
  '#E040FB', // ç´«è‰²
  '#7C4DFF', // ç´«ç¾…è˜­è‰²
  '#536DFE', // è—ç´«è‰²
  '#448AFF', // å¤©è—è‰²
  '#40C4FF'  // æ·ºè—è‰²
];

// ========== é è¨­ä»»å‹™ç¯„ä¾‹ ==========
const DEFAULT_TASKS = [
  'å”±ä¸€é¦–æ­Œçµ¦å¤§å®¶è½',
  'åš 10 å€‹æ·±è¹²',
  'èªªå‡º 5 å€‹è‹±æ–‡å–®å­—',
  'æ¨¡ä»¿ä¸€ç¨®å‹•ç‰©çš„å«è²',
  'èƒŒèª¦ä¹ä¹ä¹˜æ³•è¡¨å…¶ä¸­ä¸€æ®µ',
  'ç”¨è‹±æ–‡è‡ªæˆ‘ä»‹ç´¹',
  'èªªä¸€å€‹å†·ç¬‘è©±',
  'è·³ç¹© 20 ä¸‹',
  'åš 5 å€‹ä¼åœ°æŒºèº«',
  'èªªå‡ºä»Šå¤©å­¸åˆ°çš„ä¸€ä»¶äº‹',
  'ç•«ä¸€å€‹ç°¡å–®çš„åœ–æ¡ˆ',
  'ç”¨ä¸€éš»æ‰‹å¯«å‡ºè‡ªå·±çš„åå­—',
  'å€’æ•¸å¾ 10 æ•¸åˆ° 1',
  'åšä¸€å€‹æœ‰è¶£çš„è¡¨æƒ…ä¸¦æ‹ç…§',
  'èªªå‡º 3 ç¨®æ°´æœçš„è‹±æ–‡',
  'èµ°åˆ°æ•™å®¤æœ€é çš„è§’è½å†èµ°å›ä¾†',
  'è·Ÿå¤§å®¶åˆ†äº«ä¸€å€‹å¤¢æƒ³',
  'åš 10 ç§’çš„å¹³æ¿æ”¯æ’',
  'èªªå‡ºåœ“å‘¨ç‡å‰ 5 ä½æ•¸å­—',
  'ç”¨èº«é«”æ¯”å‡ºä¸€å€‹å­—æ¯',
  'å›ç­”ä¸€å€‹æ•¸å­¸å•é¡Œï¼š7 Ã— 8 = ?',
  'èªªå‡º 5 å€‹é¡è‰²çš„åç¨±',
  'æ¨¡ä»¿è€å¸«èªªè©±çš„æ¨£å­',
  'åœ¨ç©ºä¸­å¯«å‡ºè‡ªå·±çš„åå­—',
  'èªªå‡ºä»Šå¤©çš„æ—¥æœŸå’Œæ˜ŸæœŸå¹¾'
];

// ========== åˆå§‹åŒ–å‡½æ•¸ ==========
function generatePlayerInputs() {
  const count = parseInt(document.getElementById('playerCount').value);
  gameConfig.playerCount = count;

  const container = document.getElementById('playersInputs');
  container.innerHTML = '';

  for (let i = 0; i < count; i++) {
    const div = document.createElement('div');
    div.className = 'player-input';

    // å»ºç«‹é¡è‰²é¸æ“‡å™¨
    const colorPickerHtml = `
      <div class="color-picker" id="colorPicker${i}">
        ${PLAYER_COLORS.map((color, index) =>
          `<div class="color-option ${index === i ? 'selected' : ''}"
                style="background: ${color}"
                data-player="${i}"
                data-color="${color}"></div>`
        ).join('')}
      </div>
    `;

    div.innerHTML = `
      <div class="player-color" id="playerColor${i}" style="background: ${PLAYER_COLORS[i]}"
           onclick="toggleColorPicker(${i})" title="é»æ“Šé¸æ“‡é¡è‰²"></div>
      <div class="player-info">
        <input type="text" placeholder="ç©å®¶ ${i + 1} çš„åç¨±" id="playerName${i}" value="ç©å®¶ ${i + 1}">
        ${colorPickerHtml}
      </div>
    `;
    container.appendChild(div);
  }

  // ç¶å®šé¡è‰²é¸é …é»æ“Šäº‹ä»¶
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
      const playerIndex = parseInt(this.dataset.player);
      const color = this.dataset.color;
      selectColor(playerIndex, color, this);
    });
  });
}

function toggleColorPicker(playerIndex) {
  const picker = document.getElementById(`colorPicker${playerIndex}`);
  // é—œé–‰å…¶ä»–æ‰€æœ‰é¸è‰²å™¨
  document.querySelectorAll('.color-picker').forEach(p => {
    if (p.id !== `colorPicker${playerIndex}`) {
      p.classList.remove('active');
    }
  });
  // åˆ‡æ›ç•¶å‰é¸è‰²å™¨
  picker.classList.toggle('active');
}

function selectColor(playerIndex, color, optionElement) {
  // æ›´æ–°ç©å®¶é¡è‰²åœ“åœˆ
  document.getElementById(`playerColor${playerIndex}`).style.background = color;

  // æ›´æ–°é¸ä¸­ç‹€æ…‹
  const picker = document.getElementById(`colorPicker${playerIndex}`);
  picker.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
  optionElement.classList.add('selected');

  // é—œé–‰é¸è‰²å™¨
  picker.classList.remove('active');
}

function generateTaskInputs() {
  const count = parseInt(document.getElementById('taskCount').value);
  const container = document.getElementById('tasksInputs');
  container.innerHTML = '';

  // å˜—è©¦å¾ localStorage è¼‰å…¥ä»»å‹™
  const savedTasks = loadTasksFromStorage();

  // éš¨æ©Ÿæ‰“äº‚é è¨­ä»»å‹™
  const shuffledTasks = [...DEFAULT_TASKS].sort(() => Math.random() - 0.5);

  for (let i = 0; i < count; i++) {
    const div = document.createElement('div');
    div.className = 'task-item';
    // å„ªå…ˆä½¿ç”¨å·²å„²å­˜çš„ä»»å‹™ï¼Œå¦å‰‡ä½¿ç”¨éš¨æ©Ÿä»»å‹™
    const defaultTask = (savedTasks && savedTasks[i]) || shuffledTasks[i % shuffledTasks.length];
    div.innerHTML = `
      <label><strong>ä»»å‹™ ${i + 1}</strong> (æœ€å¤š 100 å­—)</label>
      <textarea id="task${i}" maxlength="100" placeholder="ä¾‹å¦‚ï¼šå”±ä¸€é¦–æ­Œã€åš 10 å€‹æ·±è¹²ã€å›ç­”ä¸€å€‹å•é¡Œç­‰...">${defaultTask}</textarea>
    `;
    container.appendChild(div);
  }
}

// å„²å­˜ä»»å‹™åˆ° localStorage
function saveTasksToStorage() {
  const taskCount = parseInt(document.getElementById('taskCount').value);
  const tasks = [];

  for (let i = 0; i < taskCount; i++) {
    const taskInput = document.getElementById(`task${i}`);
    if (taskInput) {
      tasks.push(taskInput.value);
    }
  }

  localStorage.setItem('monopolyGameTasks', JSON.stringify(tasks));
  localStorage.setItem('monopolyGameTaskCount', taskCount);
}

// å¾ localStorage è¼‰å…¥ä»»å‹™
function loadTasksFromStorage() {
  try {
    const savedTasks = localStorage.getItem('monopolyGameTasks');
    return savedTasks ? JSON.parse(savedTasks) : null;
  } catch (e) {
    console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', e);
    return null;
  }
}

function startGame() {
  // æ”¶é›†è¨­å®š
  gameConfig.cellCount = parseInt(document.getElementById('cellCount').value);
  gameConfig.playerCount = parseInt(document.getElementById('playerCount').value);
  gameConfig.taskSuccessScore = parseInt(document.getElementById('taskSuccessScore').value);
  gameConfig.hiddenMode = document.getElementById('hiddenMode').checked;

  // é‡ç½®å·²è¨ªå•æ ¼å­ï¼ˆèµ·é»é è¨­ç‚ºå·²è¨ªå•ï¼‰
  visitedCells = new Set([0]);

  // æ”¶é›†ç©å®¶
  players = [];
  for (let i = 0; i < gameConfig.playerCount; i++) {
    const nameInput = document.getElementById(`playerName${i}`);
    const colorElement = document.getElementById(`playerColor${i}`);
    if (!nameInput) {
      alert('è«‹å…ˆé»æ“Šã€Œç”¢ç”Ÿç©å®¶è¨­å®šæ¬„ä½ã€æŒ‰éˆ•');
      return;
    }
    players.push({
      name: nameInput.value || `ç©å®¶ ${i + 1}`,
      color: colorElement ? colorElement.style.background : PLAYER_COLORS[i],
      position: 0,
      score: 0
    });
  }

  // æ”¶é›†ä»»å‹™
  gameConfig.tasks = [];
  const taskCount = parseInt(document.getElementById('taskCount').value);
  for (let i = 0; i < taskCount; i++) {
    const taskInput = document.getElementById(`task${i}`);
    if (!taskInput) {
      alert('è«‹å…ˆé»æ“Šã€Œç”¢ç”Ÿä»»å‹™è¼¸å…¥æ¬„ä½ã€æŒ‰éˆ•');
      return;
    }
    const taskText = taskInput.value.trim();
    if (taskText) {
      gameConfig.tasks.push(taskText);
    }
  }

  if (gameConfig.tasks.length === 0) {
    alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ä»»å‹™ï¼');
    return;
  }

  // å„²å­˜ä»»å‹™åˆ° localStorage
  saveTasksToStorage();

  // åˆå§‹åŒ–æ£‹ç›¤
  initBoard();

  // åˆ‡æ›åˆ°éŠæˆ²é é¢
  document.getElementById('setupPage').style.display = 'none';
  document.getElementById('gamePage').style.display = 'block';

  // æ¸²æŸ“éŠæˆ²
  renderPlayersInfo();
  renderBoard();
  updateTurnInfo();

  // åˆå§‹åŒ–éª°å­é¡¯ç¤º
  const diceDisplay = document.getElementById('diceDisplay');
  const initialDice = createDice(1);
  diceDisplay.innerHTML = '';
  diceDisplay.appendChild(initialDice);

  // æ»¾å‹•åˆ°èµ·é»ä½ç½®ï¼Œè®“ç©å®¶çœ‹åˆ°æ‰€æœ‰äººåœ¨å“ªè£¡
  setTimeout(() => {
    scrollToCurrentPlayer();
  }, 100);
}

function initBoard() {
  board = [];
  const taskPositions = new Set();

  // éš¨æ©Ÿåˆ†é…ä»»å‹™ä½ç½®ï¼ˆé¿é–‹èµ·é»å’Œçµ‚é»ï¼‰
  const availablePositions = [];
  for (let i = 1; i < gameConfig.cellCount - 1; i++) {
    availablePositions.push(i);
  }

  // éš¨æ©Ÿé¸æ“‡ä»»å‹™ä½ç½®
  const taskCount = Math.min(gameConfig.tasks.length, availablePositions.length);
  for (let i = 0; i < taskCount; i++) {
    const randomIndex = Math.floor(Math.random() * availablePositions.length);
    taskPositions.add(availablePositions[randomIndex]);
    availablePositions.splice(randomIndex, 1);
  }

  // å»ºç«‹æ£‹ç›¤
  for (let i = 0; i < gameConfig.cellCount; i++) {
    if (i === 0) {
      board.push({ type: 'start', task: null });
    } else if (i === gameConfig.cellCount - 1) {
      board.push({ type: 'finish', task: null });
    } else if (taskPositions.has(i)) {
      const randomTask = gameConfig.tasks[Math.floor(Math.random() * gameConfig.tasks.length)];
      board.push({ type: 'task', task: randomTask });
    } else {
      board.push({ type: 'normal', task: null });
    }
  }
}

function renderPlayersInfo() {
  const container = document.getElementById('playersInfo');
  container.innerHTML = '';

  players.forEach((player, index) => {
    const card = document.createElement('div');
    card.className = 'player-card' + (index === currentPlayerIndex ? ' active' : '');
    card.innerHTML = `
      <div class="player-card-header">
        <div class="player-icon" style="background: ${player.color}"></div>
        <div class="player-name">${player.name}</div>
      </div>
      <div class="player-score">${player.score} åˆ†</div>
    `;
    container.appendChild(card);
  });
}

function renderBoard() {
  const boardDiv = document.getElementById('board');
  boardDiv.innerHTML = '';

  // è¨ˆç®—è›‡å½¢ä½ˆå±€çš„è¡Œåˆ—
  // æ‰‹æ©Ÿç‰ˆæ™‚æ¸›å°‘åˆ—æ•¸ï¼Œé¿å…çˆ†ç‰ˆ
  const isMobile = window.innerWidth <= 768;
  let cols;

  if (isMobile) {
    // æ‰‹æ©Ÿç‰ˆï¼šå›ºå®š 4 åˆ—
    cols = Math.min(4, Math.ceil(Math.sqrt(gameConfig.cellCount)));
  } else {
    // æ¡Œé¢ç‰ˆï¼šä½¿ç”¨å¹³æ–¹æ ¹è¨ˆç®—
    cols = Math.ceil(Math.sqrt(gameConfig.cellCount));
  }

  const rows = Math.ceil(gameConfig.cellCount / cols);

  boardDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

  // è›‡å½¢æ’åˆ—
  const snakeOrder = [];
  for (let row = rows - 1; row >= 0; row--) {
    if ((rows - 1 - row) % 2 === 0) {
      // å¾å·¦åˆ°å³
      for (let col = 0; col < cols; col++) {
        const index = row * cols + col;
        if (index < gameConfig.cellCount) {
          snakeOrder.push(index);
        }
      }
    } else {
      // å¾å³åˆ°å·¦
      for (let col = cols - 1; col >= 0; col--) {
        const index = row * cols + col;
        if (index < gameConfig.cellCount) {
          snakeOrder.push(index);
        }
      }
    }
  }

  // åè½‰é †åºï¼ˆå¾ä¸‹å¾€ä¸Šï¼‰
  snakeOrder.reverse();

  // å‰µå»ºæ ¼å­
  snakeOrder.forEach((cellIndex, displayIndex) => {
    const cell = board[cellIndex];
    const div = document.createElement('div');
    div.className = 'cell';

    // è¨ˆç®—é€™å€‹æ ¼å­åœ¨ç¬¬å¹¾è¡Œï¼ˆå¾ä¸‹å¾€ä¸Šï¼‰
    const row = Math.floor(displayIndex / cols);
    const col = displayIndex % cols;
    const isRightToLeft = row % 2 === 1;
    const isLastRowIncomplete = gameConfig.cellCount % cols !== 0 && row === rows - 1;

    // å¦‚æœæ˜¯æœ€å¾Œä¸€è¡Œä¸”ä¸å®Œæ•´ï¼Œéœ€è¦èª¿æ•´gridä½ç½®
    if (isLastRowIncomplete) {
      const cellsInLastRow = gameConfig.cellCount % cols;
      if (!isRightToLeft) {
        // å¾å·¦åˆ°å³çš„è¡Œï¼Œé å³å°é½Š
        div.style.gridColumnStart = cols - cellsInLastRow + col + 1;
      }
      // å¾å³åˆ°å·¦çš„è¡Œï¼Œè‡ªç„¶é å³å°é½Šï¼Œä¸éœ€è¦é¡å¤–è¨­å®š
    }

    // æª¢æŸ¥æ˜¯å¦éœ€è¦è¿·éœ§é®è“‹ï¼ˆéš±è—æ¨¡å¼ä¸”è©²æ ¼å­æœªè¢«è¨ªå•ï¼‰
    const isFogCovered = gameConfig.hiddenMode && !visitedCells.has(cellIndex);

    if (cell.type === 'start') {
      div.classList.add('start');
      div.innerHTML = `<div class="cell-number">${cellIndex}</div><div>ğŸ  èµ·é»</div>`;
    } else if (cell.type === 'finish') {
      div.classList.add('finish');
      div.innerHTML = `<div class="cell-number">${cellIndex}</div><div>ğŸ çµ‚é»</div>`;
    } else if (cell.type === 'task') {
      div.classList.add('has-task');
      div.innerHTML = `<div class="cell-number">${cellIndex}</div><div style="font-size: 2.5em;">ğŸ“‹</div>`;
    } else {
      div.innerHTML = `<div class="cell-number">${cellIndex}</div>`;
    }

    // æ·»åŠ è¿·éœ§é®è“‹æ¨£å¼
    if (isFogCovered) {
      div.classList.add('fog-covered');
    }

    // æ·»åŠ ç•¶å‰æ ¼å­é«˜äº®
    players.forEach(player => {
      if (player.position === cellIndex) {
        div.classList.add('current');
      }
    });

    // æ·»åŠ ç©å®¶æ¨™è¨˜
    const playersDiv = document.createElement('div');
    playersDiv.className = 'cell-players';
    players.forEach(player => {
      if (player.position === cellIndex) {
        const token = document.createElement('div');
        token.className = 'player-token';
        token.style.background = player.color;
        token.title = player.name;
        token.textContent = player.name.charAt(0); // é¡¯ç¤ºåç¨±ç¬¬ä¸€å€‹å­—
        playersDiv.appendChild(token);
      }
    });
    div.appendChild(playersDiv);

    boardDiv.appendChild(div);
  });
}

function updateTurnInfo() {
  const info = document.getElementById('turnInfo');
  info.innerHTML = `è¼ªåˆ° <span style="color: ${players[currentPlayerIndex].color}">${players[currentPlayerIndex].name}</span> æ“²éª°å­`;
}

function scrollToCurrentPlayer() {
  const player = players[currentPlayerIndex];
  const boardCells = document.querySelectorAll('#board .cell');

  if (boardCells && boardCells.length > player.position) {
    const currentCell = boardCells[player.position];
    if (currentCell) {
      currentCell.scrollIntoView({
        behavior: 'smooth',
        block: 'center',
        inline: 'center'
      });
    }
  }
}

// ========== 3D éª°å­å‡½æ•¸ ==========
function createDice(number) {
  const dice = document.createElement('div');
  dice.className = 'dice-3d';

  // éª°å­çš„ 6 å€‹é¢
  const faces = [
    { name: 'front', dots: 1 },
    { name: 'back', dots: 6 },
    { name: 'right', dots: 3 },
    { name: 'left', dots: 4 },
    { name: 'top', dots: 5 },
    { name: 'bottom', dots: 2 }
  ];

  faces.forEach(face => {
    const faceDiv = document.createElement('div');
    faceDiv.className = `dice-face ${face.name} face-${face.dots}`;

    // æ ¹æ“šé»æ•¸æ·»åŠ åœ“é»
    for (let i = 0; i < face.dots; i++) {
      const dot = document.createElement('div');
      dot.className = 'dice-dot';
      faceDiv.appendChild(dot);
    }

    dice.appendChild(faceDiv);
  });

  return dice;
}

function getDiceRotation(number) {
  // æ ¹æ“šé»æ•¸è¿”å›å°æ‡‰çš„æ—‹è½‰è§’åº¦
  const rotations = {
    1: 'rotateX(0deg) rotateY(0deg)',      // æ­£é¢ = 1
    2: 'rotateX(90deg) rotateY(0deg)',     // é ‚éƒ¨ = 5 (è¦é¡¯ç¤ºåº•éƒ¨2)
    3: 'rotateX(0deg) rotateY(-90deg)',    // å·¦å´ = 4 (è¦é¡¯ç¤ºå³å´3)
    4: 'rotateX(0deg) rotateY(90deg)',     // å³å´ = 3 (è¦é¡¯ç¤ºå·¦å´4)
    5: 'rotateX(-90deg) rotateY(0deg)',    // åº•éƒ¨ = 2 (è¦é¡¯ç¤ºé ‚éƒ¨5)
    6: 'rotateX(0deg) rotateY(180deg)'     // èƒŒé¢ = 6
  };
  return rotations[number];
}

// ========== éŠæˆ²é‚è¼¯ ==========
function rollDice() {
  if (isRolling) return;
  isRolling = true;

  // ç¦ç”¨éª°å­é»æ“Š
  const diceDisplay = document.getElementById('diceDisplay');
  diceDisplay.classList.add('disabled');

  // å»ºç«‹ 3D éª°å­
  const dice = createDice(1);
  diceDisplay.innerHTML = '';
  diceDisplay.appendChild(dice);

  // æ·»åŠ æ»¾å‹•å‹•ç•«
  dice.classList.add('rolling');

  // éš¨æ©Ÿæœ€çµ‚é»æ•¸
  const finalNumber = Math.floor(Math.random() * 6) + 1;

  // çµ±è¨ˆéª°å­çµæœ
  diceStats[finalNumber]++;
  const totalRolls = Object.values(diceStats).reduce((a, b) => a + b, 0);
  console.log(`éª°å­çµæœ: ${finalNumber} | çµ±è¨ˆ:`, diceStats, `| ç¸½æ¬¡æ•¸: ${totalRolls}`);

  // å‹•ç•«çµæŸå¾Œé¡¯ç¤ºçµæœï¼ˆ0.6ç§’ï¼‰
  setTimeout(() => {
    dice.classList.remove('rolling');
    dice.style.transform = getDiceRotation(finalNumber);

    // çŸ­æš«å»¶é²å¾Œé—œé–‰å´é‚Šæ¬„ä¸¦ç§»å‹•ç©å®¶
    setTimeout(() => {
      // é—œé–‰å´é‚Šæ¬„
      toggleSidebar();

      // å†å»¶é²ä¸€ä¸‹è®“å´é‚Šæ¬„å‹•ç•«å®Œæˆå¾Œæ‰ç§»å‹•ç©å®¶å’Œæ»¾å‹•åˆ°ä½ç½®
      setTimeout(() => {
        // å…ˆæ»¾å‹•åˆ°ç•¶å‰ç©å®¶ä½ç½®
        scrollToCurrentPlayer();

        // ç¨å¾®å»¶é²å¾Œé–‹å§‹ç§»å‹•ç©å®¶
        setTimeout(() => {
          movePlayer(finalNumber);
        }, 200);
      }, 300);
    }, 400);
  }, 600);
}

function movePlayer(steps) {
  const player = players[currentPlayerIndex];
  const targetPosition = Math.min(player.position + steps, gameConfig.cellCount - 1);

  // é€æ­¥ç§»å‹•å‹•ç•«
  let currentStep = 0;
  const moveInterval = setInterval(() => {
    if (currentStep < steps && player.position < gameConfig.cellCount - 1) {
      player.position++;

      // ç©å®¶ç¶“éçš„æ ¼å­éƒ½æ¨™è¨˜ç‚ºå·²è¨ªå•ï¼ˆç§»é™¤è¿·éœ§ï¼‰
      visitedCells.add(player.position);

      renderBoard();
      renderPlayersInfo();
      currentStep++;
    } else {
      clearInterval(moveInterval);

      // æª¢æŸ¥æ˜¯å¦åˆ°é”çµ‚é»
      if (player.position >= gameConfig.cellCount - 1) {
        setTimeout(() => showResults(), 1000);
      } else {
        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»å‹™
        const cell = board[player.position];
        if (cell.type === 'task' && cell.task) {
          setTimeout(() => showTask(cell.task), 500);
        } else {
          setTimeout(() => nextTurn(), 1000);
        }
      }
    }
  }, 300);
}

function showTask(taskText) {
  const player = players[currentPlayerIndex];
  document.getElementById('taskText').innerHTML = `
    <strong>${player.name}</strong> çš„ä»»å‹™ï¼š<br><br>
    ${taskText}
  `;
  document.getElementById('taskModal').classList.add('active');
}

function completeTask(success) {
  document.getElementById('taskModal').classList.remove('active');

  if (success) {
    players[currentPlayerIndex].score += gameConfig.taskSuccessScore;
    renderPlayersInfo();
  }

  setTimeout(() => nextTurn(), 500);
}

function nextTurn() {
  currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
  renderPlayersInfo();
  updateTurnInfo();

  // å•Ÿç”¨éª°å­é»æ“Š
  const diceDisplay = document.getElementById('diceDisplay');
  diceDisplay.classList.remove('disabled');
  isRolling = false;
}

// ========== çµæœé¡¯ç¤º ==========
function showResults() {
  document.getElementById('gamePage').style.display = 'none';
  document.getElementById('resultPage').style.display = 'block';

  // æ’åºç©å®¶
  const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

  // é¡¯ç¤ºå† è»
  document.getElementById('winnerText').textContent = `ğŸ‰ ${sortedPlayers[0].name} ç²å‹ï¼ ğŸ‰`;

  // é¡¯ç¤ºè¨ˆåˆ†æ¿
  const scoreboard = document.getElementById('scoreboard');
  scoreboard.innerHTML = '';

  sortedPlayers.forEach((player, index) => {
    const item = document.createElement('div');
    item.className = 'score-item';
    if (index === 0) item.classList.add('rank1');
    else if (index === 1) item.classList.add('rank2');
    else if (index === 2) item.classList.add('rank3');

    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
    const medal = medals[index] || 'ğŸ…';

    item.innerHTML = `
      <div class="score-rank">${medal}</div>
      <div class="score-player">
        <div class="score-player-icon" style="background: ${player.color}"></div>
        <div class="score-player-name">${player.name}</div>
      </div>
      <div class="score-points">${player.score} åˆ†</div>
    `;
    scoreboard.appendChild(item);
  });
}

// ========== åŒ¯å‡º/åŒ¯å…¥è¨­å®š ==========
function exportSettings() {
  // æ”¶é›†ç•¶å‰æ‰€æœ‰è¨­å®š
  const settings = {
    version: '1.0',
    cellCount: parseInt(document.getElementById('cellCount').value),
    playerCount: parseInt(document.getElementById('playerCount').value),
    taskCount: parseInt(document.getElementById('taskCount').value),
    taskSuccessScore: parseInt(document.getElementById('taskSuccessScore').value),
    hiddenMode: document.getElementById('hiddenMode').checked,
    tasks: []
  };

  // æ”¶é›†ä»»å‹™
  const taskCount = parseInt(document.getElementById('taskCount').value);
  for (let i = 0; i < taskCount; i++) {
    const taskInput = document.getElementById(`task${i}`);
    if (taskInput) {
      settings.tasks.push(taskInput.value.trim());
    }
  }

  // ç”¢ç”Ÿ JSON æª”æ¡ˆ
  const dataStr = JSON.stringify(settings, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });

  // å»ºç«‹ä¸‹è¼‰é€£çµ
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `å¤§å¯Œç¿éŠæˆ²è¨­å®š_${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  alert('è¨­å®šå·²åŒ¯å‡ºï¼');
}

function importSettings(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const settings = JSON.parse(e.target.result);

      // é©—è­‰è¨­å®šæª”æ ¼å¼
      if (!settings.version || !settings.tasks) {
        alert('è¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼');
        return;
      }

      // å¥—ç”¨è¨­å®š
      if (settings.cellCount) document.getElementById('cellCount').value = settings.cellCount;
      if (settings.playerCount) {
        document.getElementById('playerCount').value = settings.playerCount;
        generatePlayerInputs();
      }
      if (settings.taskCount) document.getElementById('taskCount').value = settings.taskCount;
      if (settings.taskSuccessScore) document.getElementById('taskSuccessScore').value = settings.taskSuccessScore;
      if (settings.hiddenMode !== undefined) document.getElementById('hiddenMode').checked = settings.hiddenMode;

      // ç”¢ç”Ÿä»»å‹™æ¬„ä½ä¸¦å¡«å…¥ä»»å‹™
      generateTaskInputs();

      // å¡«å…¥ä»»å‹™å…§å®¹
      setTimeout(() => {
        settings.tasks.forEach((task, i) => {
          const taskInput = document.getElementById(`task${i}`);
          if (taskInput) {
            taskInput.value = task;
          }
        });
      }, 100);

      alert('è¨­å®šå·²æˆåŠŸåŒ¯å…¥ï¼');
    } catch (error) {
      alert('åŒ¯å…¥å¤±æ•—ï¼šè¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼\n' + error.message);
    }
  };
  reader.readAsText(file);

  // é‡ç½®æª”æ¡ˆè¼¸å…¥ï¼Œå…è¨±é‡è¤‡åŒ¯å…¥ç›¸åŒæª”æ¡ˆ
  event.target.value = '';
}

// ========== å´é‚Šæ¬„æ§åˆ¶ ==========
function toggleSidebar() {
  const sidebar = document.getElementById('diceControlSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const floatingBtn = document.querySelector('.floating-button');

  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');

  if (sidebar.classList.contains('open')) {
    floatingBtn.classList.add('hidden');

    // æ‰“é–‹å´é‚Šæ¬„æ™‚ï¼Œç­‰å¾…æ»‘å‡ºå‹•ç•«å®Œæˆå¾Œå†æ»¾å‹•åˆ°ç•¶å‰ç©å®¶ä½ç½®
    setTimeout(() => {
      const scrollContainer = document.querySelector('.dice-control-scrollable');
      const activeCard = document.querySelector('.player-card.active');

      if (scrollContainer && activeCard) {
        // ä½¿ç”¨ scrollIntoView è®“ç•¶å‰ç©å®¶å¡ç‰‡é¡¯ç¤ºåœ¨å¯è¦‹å€åŸŸ
        activeCard.scrollIntoView({
          behavior: 'smooth',
          block: 'center',
          inline: 'nearest'
        });
      }
    }, 350); // ç­‰å¾…å´é‚Šæ¬„æ»‘å‡ºå‹•ç•«å®Œæˆï¼ˆå´é‚Šæ¬„å‹•ç•«æ˜¯ 0.3sï¼‰
  } else {
    floatingBtn.classList.remove('hidden');
  }
}

// ========== åˆå§‹åŒ– ==========
window.onload = function() {
  // è¼‰å…¥ä¸Šæ¬¡å„²å­˜çš„ä»»å‹™æ•¸é‡
  const savedTaskCount = localStorage.getItem('monopolyGameTaskCount');
  if (savedTaskCount) {
    document.getElementById('taskCount').value = savedTaskCount;
  }

  generatePlayerInputs();
  generateTaskInputs();
};

// è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°æ¸²æŸ“æ£‹ç›¤ï¼ˆè™•ç†æ‰‹æ©Ÿæ—‹è½‰ç­‰æƒ…æ³ï¼‰
let resizeTimeout;
window.addEventListener('resize', function() {
  // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é »ç¹é‡æ–°æ¸²æŸ“
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    // åªåœ¨éŠæˆ²é€²è¡Œä¸­æ‰é‡æ–°æ¸²æŸ“
    if (document.getElementById('gamePage').style.display !== 'none') {
      renderBoard();
    }
  }, 300);
});
</script>

</body>
</html>
