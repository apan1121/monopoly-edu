<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Primary Meta Tags -->
<title>ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ² | å¯“æ•™æ–¼æ¨‚</title>
<meta name="title" content="ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ² | å¯“æ•™æ–¼æ¨‚">
<meta name="description" content="å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œå« 3D éª°å­ã€ä»»å‹™ç³»çµ±ã€è¿·éœ§æ¨¡å¼ã€‚é©ç”¨æ–¼é«”è‚²ã€è‹±æ–‡ã€æ•¸å­¸ç­‰å„ç§‘æ•™å­¸ï¼Œè®“å­¸ç”Ÿé€ééŠæˆ²å®ŒæˆçœŸå¯¦å­¸ç¿’ä»»å‹™ï¼">
<meta name="keywords" content="å¤§å¯Œç¿éŠæˆ²,æ•™å­¸éŠæˆ²,èª²å ‚éŠæˆ²,äº’å‹•éŠæˆ²,æ•™è‚²éŠæˆ²,æ¡ŒéŠ,å­¸ç¿’éŠæˆ²,ä»»å‹™éŠæˆ²,éª°å­éŠæˆ²,å…è²»éŠæˆ²">
<meta name="author" content="Educational Game Project">
<meta name="robots" content="index, follow">

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website">
<meta property="og:url" content="https://your-domain.com/">
<meta property="og:title" content="ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ²">
<meta property="og:description" content="å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œè®“å­¸ç¿’è®Šå¾—æ›´æœ‰è¶£ï¼">
<meta property="og:image" content="./screenshots/preview.jpg">
<meta property="og:site_name" content="å¤§å¯Œç¿æ•™å­¸éŠæˆ²">
<meta property="og:locale" content="zh_TW">

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image">
<meta property="twitter:url" content="https://your-domain.com/">
<meta property="twitter:title" content="ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ² | èª²å ‚äº’å‹•éŠæˆ²">
<meta property="twitter:description" content="å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œè®“å­¸ç¿’è®Šå¾—æ›´æœ‰è¶£ï¼">
<meta property="twitter:image" content="./screenshots/preview.jpg">

<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ²</text></svg>">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ²</text></svg>">

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="å¤§å¯Œç¿éŠæˆ²">

<!-- Structured Data / JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebApplication",
  "name": "å¤§å¯Œç¿æ•™å­¸éŠæˆ²",
  "description": "å°ˆç‚ºèª²å ‚æ•™å­¸è¨­è¨ˆçš„äº’å‹•å¼å¤§å¯Œç¿éŠæˆ²ï¼Œæ”¯æ´ 2-6 äººéŠç©ï¼Œå« 3D éª°å­ã€ä»»å‹™ç³»çµ±ã€è¿·éœ§æ¨¡å¼",
  "url": "https://your-domain.com/",
  "applicationCategory": "EducationalApplication",
  "operatingSystem": "Web Browser",
  "offers": {
    "@type": "Offer",
    "price": "0",
    "priceCurrency": "TWD"
  },
  "author": {
    "@type": "Organization",
    "name": "Educational Game Project"
  },
  "inLanguage": "zh-TW",
  "browserRequirements": "Requires JavaScript. Requires HTML5.",
  "softwareVersion": "1.0",
  "releaseNotes": "åˆç‰ˆç™¼å¸ƒ",
  "featureList": [
    "3D éª°å­å‹•ç•«",
    "è‡ªè¨‚ä»»å‹™ç³»çµ±",
    "2-6 äººå¤šäººéŠæˆ²",
    "è¿·éœ§æ¢ç´¢æ¨¡å¼",
    "éŸ¿æ‡‰å¼è¨­è¨ˆ",
    "è¨­å®šåŒ¯å…¥åŒ¯å‡º",
    "å³æ™‚è¨ˆåˆ†ç³»çµ±"
  ]
}
</script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
    min-height: 100vh;
    padding: 20px;
    overflow-x: hidden;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .seo-preview {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
  }

  .seo-preview img {
    width: min(100%, 900px);
    border-radius: 20px;
    box-shadow: 0 15px 30px rgba(0,0,0,0.25);
    border: 4px solid rgba(255, 255, 255, 0.8);
  }

  h1 {
    text-align: center;
    color: white;
    font-size: 3em;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    margin-bottom: 30px;
    animation: titleBounce 2s ease-in-out infinite;
  }

  @keyframes titleBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* ========== è¨­å®šé é¢ ========== */
  #setupPage {
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 800px;
    margin: 0 auto;
  }

  .setup-section {
    margin-bottom: 30px;
  }

  .setup-section h2 {
    color: #667eea;
    margin-bottom: 15px;
    font-size: 1.5em;
  }

  .input-group {
    margin-bottom: 15px;
  }

  .input-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
  }

  .input-group input,
  .input-group textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e0e6ed;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    background: #ffffff;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .input-group input:hover,
  .input-group textarea:hover {
    border-color: #c1c9d2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .input-group input:focus,
  .input-group textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  .input-group textarea {
    resize: vertical;
    min-height: 80px;
    line-height: 1.6;
  }

  .player-input {
    display: grid;
    grid-template-columns: 40px 1fr;
    gap: 10px;
    align-items: start;
    margin-bottom: 15px;
    padding: 12px;
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
    border-radius: 12px;
    border: 1px solid #e8ecf7;
    transition: all 0.3s ease;
  }

  .player-input:hover {
    border-color: #d0d9eb;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.08);
  }

  .player-color {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    cursor: pointer;
    transition: transform 0.2s;
  }

  .player-color:hover {
    transform: scale(1.1);
  }

  .player-info {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .player-info input[type="text"] {
    padding: 12px 16px;
    border: 2px solid #e0e6ed;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    background: #ffffff;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .player-info input[type="text"]:hover {
    border-color: #c1c9d2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .player-info input[type="text"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  .color-picker {
    display: none;
    grid-template-columns: repeat(10, 28px);
    gap: 5px;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 8px;
    margin-top: 5px;
  }

  .color-picker.active {
    display: grid;
  }

  .color-option {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid #ddd;
    cursor: pointer;
    transition: all 0.2s;
  }

  .color-option:hover {
    transform: scale(1.15);
    border-color: #999;
  }

  .color-option.selected {
    border-color: #333;
    border-width: 3px;
    box-shadow: 0 0 8px rgba(0,0,0,0.3);
  }

  .task-item {
    background: linear-gradient(135deg, #fff9f0 0%, #fff5e8 100%);
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 12px;
    border-left: 4px solid #667eea;
    border: 1px solid #ffe8d1;
    border-left: 4px solid #667eea;
    transition: all 0.3s ease;
  }

  .task-item:hover {
    border-left-color: #764ba2;
    box-shadow: 0 2px 12px rgba(102, 126, 234, 0.12);
    transform: translateX(2px);
  }

  .task-item label {
    font-weight: 600;
    color: #555;
    display: block;
    margin-bottom: 8px;
  }

  .task-item textarea {
    width: 100%;
    margin-top: 5px;
    padding: 12px 16px;
    background: #ffffff;
    border: 2px solid #e0e6ed;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    line-height: 1.6;
    resize: vertical;
    min-height: 80px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .task-item textarea:hover {
    border-color: #c1c9d2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .task-item textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  .task-points-input {
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .task-points-input label {
    font-size: 0.9em;
    color: #666;
    font-weight: 600;
    margin: 0;
  }

  .task-points-input input[type="number"] {
    width: 80px;
    padding: 8px 12px;
    border: 2px solid #e0e6ed;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    background: #ffffff;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .task-points-input input[type="number"]:hover {
    border-color: #c1c9d2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .task-points-input input[type="number"]:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  .task-points-input span {
    font-size: 0.9em;
    color: #666;
  }

  .snake-ladder-input {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e0e6ed;
    border-radius: 8px;
    font-size: 15px;
    font-family: inherit;
    background: #ffffff;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .snake-ladder-input:hover {
    border-color: #c1c9d2;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
  }

  .snake-ladder-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
    transform: translateY(-1px);
  }

  .btn {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    padding: 15px 30px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.2s, box-shadow 0.2s;
  }

  .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.3);
  }

  .btn:active {
    transform: translateY(0);
  }

  .btn-small {
    padding: 8px 16px;
    font-size: 14px;
  }

  .btn-success {
    background: linear-gradient(135deg, #11998e, #38ef7d);
  }

  .btn-danger {
    background: linear-gradient(135deg, #eb3349, #f45c43);
  }

  /* ========== éŠæˆ²é é¢ ========== */
  #gamePage {
    display: none;
  }

  .game-header {
    background: white;
    border-radius: 20px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
  }

  .game-main {
    position: relative;
  }

  /* æµ®å‹•æ§åˆ¶æŒ‰éˆ• */
  .floating-button {
    position: fixed;
    right: 30px;
    bottom: 30px;
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    border: none;
    width: 70px;
    height: 70px;
    border-radius: 50%;
    font-size: 32px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    z-index: 999;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .floating-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
  }

  .floating-button.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .players-info-compact {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .player-card {
    background: linear-gradient(135deg, #f5f7fa, #e8eef5);
    padding: 10px 12px;
    border-radius: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.3s;
    border: 2px solid transparent;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .player-card.active {
    border-color: #ffd700;
    background: linear-gradient(135deg, #fff8dc, #fffacd);
    box-shadow: 0 3px 12px rgba(255, 215, 0, 0.4);
    transform: translateX(5px);
  }

  .player-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .player-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid white;
    flex-shrink: 0;
  }

  .player-name {
    font-weight: bold;
    font-size: 0.95em;
    color: #333;
  }

  .player-score {
    font-size: 1.1em;
    font-weight: bold;
    color: #667eea;
    white-space: nowrap;
  }

  /* ========== æ£‹ç›¤ ========== */
  #boardContainer {
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 1200px;
    margin: 0 auto;
  }

  #board {
    display: grid;
    gap: 8px;
    max-width: 100%;
    margin: 0 auto;
    justify-items: stretch;
  }

  /* è™•ç†è›‡å½¢æ’åˆ—æ™‚ä¸å®Œæ•´è¡Œçš„å°é½Š */
  .cell.align-right {
    grid-column-start: auto;
  }

  .cell {
    aspect-ratio: 1;
    background: linear-gradient(135deg, #e0e7ff, #cfe2ff);
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 8px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.15);
    position: relative;
    font-size: 0.85em;
    transition: transform 0.3s, box-shadow 0.3s;
    border: 3px solid transparent;
  }

  .cell:hover {
    transform: translateY(-3px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.25);
  }

  .cell.start {
    background: linear-gradient(135deg, #56ab2f, #a8e063);
    font-weight: bold;
    font-size: 1.1em;
    color: white;
  }

  .cell.finish {
    background: linear-gradient(135deg, #ff6b6b, #feca57);
    font-weight: bold;
    font-size: 1.1em;
    color: white;
  }

  .cell.has-task {
    background: linear-gradient(135deg, #ffd89b, #19547b);
    color: white;
    font-weight: 500;
  }

  .cell.current {
    border-color: #ffd700;
    animation: cellGlow 1s ease-in-out infinite;
  }

  @keyframes cellGlow {
    0%, 100% { box-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
    50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
  }

  /* è¿·éœ§é®è“‹æ•ˆæœ */
  .cell.fog-covered {
    position: relative;
    overflow: hidden;
  }

  .cell.fog-covered::before {
    content: '?';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(150, 150, 150, 0.95), rgba(100, 100, 100, 0.95));
    backdrop-filter: blur(3px);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5em;
    color: rgba(255, 255, 255, 0.8);
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    z-index: 10;
    animation: fogPulse 2s ease-in-out infinite;
  }

  @keyframes fogPulse {
    0%, 100% { opacity: 0.95; }
    50% { opacity: 0.85; }
  }

  .cell.fog-covered .cell-number,
  .cell.fog-covered > div:not(.cell-players) {
    visibility: hidden;
  }

  .cell-number {
    position: absolute;
    top: 3px;
    left: 6px;
    font-size: 0.7em;
    font-weight: bold;
    background: rgba(255,255,255,0.7);
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cell-players {
    position: absolute;
    bottom: 5px;
    display: flex;
    gap: 3px;
    flex-wrap: wrap;
    justify-content: center;
    max-width: 90%;
  }

  .player-token {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    animation: tokenBounce 0.5s ease-out;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: bold;
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
  }

  @keyframes tokenBounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
  }

  /* ç•¶å‰è¼ªåˆ°çš„ç©å®¶æ£‹å­ */
  .player-token.current-turn {
    width: 32px;
    height: 32px;
    border: 3px solid white;
    box-shadow:
      0 0 0 3px rgba(255, 215, 0, 0.8),
      0 0 20px rgba(255, 215, 0, 0.6),
      0 0 30px rgba(255, 215, 0, 0.4),
      0 4px 8px rgba(0,0,0,0.3);
    animation: currentPlayerPulse 2s ease-in-out infinite;
    z-index: 10;
    position: relative;
  }

  @keyframes currentPlayerPulse {
    0%, 100% {
      transform: scale(1);
      box-shadow:
        0 0 0 3px rgba(255, 215, 0, 0.8),
        0 0 20px rgba(255, 215, 0, 0.6),
        0 0 30px rgba(255, 215, 0, 0.4),
        0 4px 8px rgba(0,0,0,0.3);
    }
    50% {
      transform: scale(1.15);
      box-shadow:
        0 0 0 4px rgba(255, 215, 0, 1),
        0 0 25px rgba(255, 215, 0, 0.8),
        0 0 40px rgba(255, 215, 0, 0.6),
        0 6px 12px rgba(0,0,0,0.4);
    }
  }

  /* ========== éª°å­æ§åˆ¶å´é‚Šæ¬„ ========== */
  .dice-control {
    position: fixed;
    right: -320px;
    top: 0;
    width: 300px;
    height: 100vh;
    background: white;
    box-shadow: -5px 0 20px rgba(0,0,0,0.3);
    transition: right 0.3s ease-in-out;
    z-index: 998;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .dice-control.open {
    right: 0;
  }

  .dice-control-fixed {
    flex-shrink: 0;
    padding: 20px;
    padding-bottom: 10px;
  }

  .dice-control-scrollable {
    flex: 1;
    overflow-y: auto;
    padding: 0 20px 20px 20px;
  }

  .dice-control-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }

  .close-sidebar {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: #666;
    padding: 5px;
    line-height: 1;
  }

  .close-sidebar:hover {
    color: #333;
  }

  /* é®ç½©å±¤ */
  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    z-index: 997;
  }

  .sidebar-overlay.active {
    opacity: 1;
    visibility: visible;
  }


  #diceDisplay {
    perspective: 1000px;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 15px 0;
    cursor: pointer;
    transition: transform 0.2s;
  }

  #diceDisplay:hover:not(.disabled) {
    transform: scale(1.05);
  }

  #diceDisplay.disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .dice-3d {
    width: 100px;
    height: 100px;
    position: relative;
    transform-style: preserve-3d;
    transition: transform 0.1s;
    pointer-events: none;
  }

  .dice-3d.rolling {
    animation: diceRoll 0.6s ease-out;
  }

  @keyframes diceRoll {
    0% { transform: rotateX(0deg) rotateY(0deg); }
    25% { transform: rotateX(180deg) rotateY(180deg); }
    50% { transform: rotateX(360deg) rotateY(360deg); }
    75% { transform: rotateX(540deg) rotateY(540deg); }
    100% { transform: rotateX(720deg) rotateY(720deg); }
  }

  .dice-face {
    position: absolute;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, #ffffff, #f0f0f0);
    border: 2px solid #333;
    border-radius: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    padding: 10px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
  }

  .dice-dot {
    width: 18px;
    height: 18px;
    background: #333;
    border-radius: 50%;
    box-shadow: inset 0 2px 3px rgba(0,0,0,0.3);
  }

  /* éª°å­å„é¢çš„ä½ç½® */
  .dice-face.front  { transform: translateZ(50px); }
  .dice-face.back   { transform: rotateY(180deg) translateZ(50px); }
  .dice-face.right  { transform: rotateY(90deg) translateZ(50px); }
  .dice-face.left   { transform: rotateY(-90deg) translateZ(50px); }
  .dice-face.top    { transform: rotateX(90deg) translateZ(50px); }
  .dice-face.bottom { transform: rotateX(-90deg) translateZ(50px); }

  /* å„é¢é»æ•¸çš„ä½ˆå±€ */
  .dice-face.face-1 {
    justify-content: center;
    align-items: center;
  }

  .dice-face.face-2 {
    display: grid;
    grid-template-areas:
      "a . ."
      ". . ."
      ". . b";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-2 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-2 .dice-dot:nth-child(2) { grid-area: b; }

  .dice-face.face-3 {
    display: grid;
    grid-template-areas:
      "a . ."
      ". b ."
      ". . c";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-3 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-3 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-3 .dice-dot:nth-child(3) { grid-area: c; }

  .dice-face.face-4 {
    display: grid;
    grid-template-areas:
      "a . b"
      ". . ."
      "c . d";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-4 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-4 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-4 .dice-dot:nth-child(3) { grid-area: c; }
  .dice-face.face-4 .dice-dot:nth-child(4) { grid-area: d; }

  .dice-face.face-5 {
    display: grid;
    grid-template-areas:
      "a . b"
      ". c ."
      "d . e";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-5 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-5 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-5 .dice-dot:nth-child(3) { grid-area: c; }
  .dice-face.face-5 .dice-dot:nth-child(4) { grid-area: d; }
  .dice-face.face-5 .dice-dot:nth-child(5) { grid-area: e; }

  .dice-face.face-6 {
    display: grid;
    grid-template-areas:
      "a . b"
      "c . d"
      "e . f";
    padding: 15px;
    gap: 0;
  }
  .dice-face.face-6 .dice-dot:nth-child(1) { grid-area: a; }
  .dice-face.face-6 .dice-dot:nth-child(2) { grid-area: b; }
  .dice-face.face-6 .dice-dot:nth-child(3) { grid-area: c; }
  .dice-face.face-6 .dice-dot:nth-child(4) { grid-area: d; }
  .dice-face.face-6 .dice-dot:nth-child(5) { grid-area: e; }
  .dice-face.face-6 .dice-dot:nth-child(6) { grid-area: f; }

  /* ========== ä»»å‹™å½ˆçª— ========== */
  .modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    animation: fadeIn 0.3s;
  }

  .modal.active {
    display: flex;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .modal-content {
    background: white;
    border-radius: 20px;
    padding: 40px;
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 50px rgba(0,0,0,0.5);
    animation: slideUp 0.4s ease-out;
  }

  @keyframes slideUp {
    from {
      transform: translateY(50px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  .modal-header {
    font-size: 1.8em;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 15px;
    text-align: center;
  }

  .modal-body {
    font-size: 1.3em;
    line-height: 1.6;
    color: #333;
    margin-bottom: 30px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 5px solid #667eea;
  }

  .modal-footer {
    display: flex;
    gap: 15px;
    justify-content: center;
  }

  /* ========== æŠ½å¡æ¨£å¼ ========== */
  .card-container {
    perspective: 1000px;
    margin-bottom: 20px;
    display: flex;
    justify-content: center;
  }

  .card {
    width: 350px;
    height: 250px;
    position: relative;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .card:hover {
    transform: scale(1.02);
  }

  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.8s;
    transform-style: preserve-3d;
  }

  .card.flipped .card-inner {
    transform: rotateY(180deg);
  }

  .card-front,
  .card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    -webkit-backface-visibility: hidden;
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .card-front {
    background:
      radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
      radial-gradient(circle at 80% 50%, rgba(255, 255, 255, 0.2) 0%, transparent 50%),
      linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: absolute;
    top: 0;
    left: 0;
    overflow: hidden;
    border: 3px solid rgba(255, 255, 255, 0.3);
    z-index: 2;
  }

  .card.flipped .card-front {
    z-index: 0;
  }

  /* å¡ç‰‡èƒŒé¢èŠ±ç´‹ */
  .card-front::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 80%;
    height: 80%;
    background: repeating-linear-gradient(
      45deg,
      transparent,
      transparent 15px,
      rgba(255, 255, 255, 0.05) 15px,
      rgba(255, 255, 255, 0.05) 30px
    ),
    repeating-linear-gradient(
      -45deg,
      transparent,
      transparent 15px,
      rgba(255, 255, 255, 0.05) 15px,
      rgba(255, 255, 255, 0.05) 30px
    );
    border-radius: 10px;
  }

  .card-back {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    transform: rotateY(180deg);
    color: white;
    border: 3px solid rgba(255, 255, 255, 0.3);
    overflow: hidden;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1;
  }

  .card.flipped .card-back {
    z-index: 2;
  }

  .card-back-pattern {
    text-align: center;
    padding: 30px;
    position: relative;
    z-index: 1;
  }

  .card-icon {
    font-size: 80px;
    margin-bottom: 10px;
    animation: cardFloat 2s ease-in-out infinite;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
  }

  @keyframes cardFloat {
    0%, 100% {
      transform: translateY(0px) rotate(-5deg);
    }
    50% {
      transform: translateY(-15px) rotate(5deg);
    }
  }

  .card-hint {
    font-size: 20px;
    font-weight: bold;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    letter-spacing: 2px;
  }

  .card-task-content {
    padding: 30px 25px;
    font-size: 1.1em;
    line-height: 1.6;
    text-align: center;
    font-weight: 500;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    word-break: break-word;
    overflow-wrap: break-word;
  }

  .card-task-content strong {
    display: block;
    margin-bottom: 10px;
    font-size: 1.2em;
  }

  .card.flipped {
    pointer-events: none;
  }

  /* ========== çµæœé é¢ ========== */
  #resultPage {
    display: none;
    background: white;
    border-radius: 20px;
    padding: 40px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    max-width: 800px;
    margin: 0 auto;
  }

  .result-title {
    text-align: center;
    font-size: 2.5em;
    color: #667eea;
    margin-bottom: 30px;
  }

  .winner {
    text-align: center;
    font-size: 3em;
    color: #ffd700;
    margin-bottom: 30px;
    animation: winnerShake 1s ease-in-out infinite;
  }

  @keyframes winnerShake {
    0%, 100% { transform: rotate(0deg); }
    25% { transform: rotate(-5deg); }
    75% { transform: rotate(5deg); }
  }

  .scoreboard {
    margin-bottom: 30px;
  }

  .score-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
    padding: 20px;
    border-radius: 15px;
    margin-bottom: 15px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  }

  .score-item.rank1 {
    background: linear-gradient(135deg, #ffd89b, #ff9a56);
    transform: scale(1.05);
  }

  .score-item.rank2 {
    background: linear-gradient(135deg, #dfe9f3, #b8c6db);
  }

  .score-item.rank3 {
    background: linear-gradient(135deg, #f5d0a9, #d7b899);
  }

  .score-rank {
    font-size: 2em;
    font-weight: bold;
    margin-right: 20px;
  }

  .score-player {
    display: flex;
    align-items: center;
    gap: 15px;
    flex: 1;
  }

  .score-player-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 3px solid white;
  }

  .score-player-name {
    font-size: 1.5em;
    font-weight: bold;
  }

  .score-points {
    font-size: 2em;
    font-weight: bold;
    color: #667eea;
  }

  /* ========== éŸ¿æ‡‰å¼è¨­è¨ˆ ========== */
  @media (max-width: 768px) {
    h1 { font-size: 2em; }
    .player-card { padding: 10px 15px; }
    .modal-content { padding: 20px; }

    .card {
      width: 280px;
      height: 200px;
    }

    .card-icon {
      font-size: 60px;
    }

    .card-hint {
      font-size: 16px;
    }

    .card-task-content {
      padding: 20px 15px;
      font-size: 0.95em;
    }

    .card-task-content strong {
      font-size: 1.1em;
      margin-bottom: 8px;
    }

    .floating-button {
      width: 60px;
      height: 60px;
      font-size: 28px;
      right: 20px;
      bottom: 20px;
    }
  }
</style>
</head>
<body>

<div class="container">
  <h1>ğŸ² å¤§å¯Œç¿æ•™å­¸éŠæˆ²</h1>

  <!-- ========== è¨­å®šé é¢ ========== -->
  <div id="setupPage">
    <!-- åŸºæœ¬è¨­å®š -->
    <div class="setup-section">
      <h2>ğŸ“‹ åŸºæœ¬è¨­å®š</h2>
      <div class="input-group">
        <label>æ£‹ç›¤æ ¼å­æ•¸é‡ (å»ºè­° 20-50 æ ¼)</label>
        <input type="number" id="cellCount" min="20" max="50" value="30">
      </div>
      <div class="input-group">
        <label>ç©å®¶æ•¸é‡ (2-6 äºº)</label>
        <input type="number" id="playerCount" min="2" max="6" value="4">
      </div>
      <button class="btn btn-small" onclick="generatePlayerInputs()">ç”¢ç”Ÿç©å®¶è¨­å®šæ¬„ä½</button>
    </div>

    <!-- ç©å®¶è¨­å®š -->
    <div class="setup-section">
      <h2>ğŸ‘¥ ç©å®¶è¨­å®š</h2>
      <div id="playersInputs"></div>
    </div>

    <!-- ä»»å‹™è¨­å®š -->
    <div class="setup-section">
      <h2>ğŸ“ ä»»å‹™è¨­å®š</h2>
      <div class="input-group">
        <label>ä»»å‹™æ•¸é‡ (å»ºè­° 5-15 å€‹)</label>
        <input type="number" id="taskCount" min="1" max="20" value="8">
      </div>
      <div class="input-group">
        <label>ä»»å‹™æˆåŠŸç²å¾—åˆ†æ•¸</label>
        <input type="number" id="taskSuccessScore" min="1" max="100" value="10">
      </div>
      <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="hiddenMode" style="width: auto; margin: 0;">
        <label style="margin: 0; cursor: pointer;" for="hiddenMode">å•Ÿç”¨éš±è—æ¨¡å¼ï¼ˆæ ¼å­åœ¨ç©å®¶èµ°éå‰ç‚ºè¿·éœ§é®è“‹ï¼‰</label>
      </div>
      <div class="input-group" style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="snakeLadderMode" style="width: auto; margin: 0;" onchange="toggleSnakeLadderSettings()">
        <label style="margin: 0; cursor: pointer;" for="snakeLadderMode">ğŸğŸªœ å•Ÿç”¨è›‡æ¢¯æ¨¡å¼ï¼ˆå¢åŠ è›‡å’Œæ¢¯å­ï¼‰</label>
      </div>

      <!-- è›‡æ¢¯è¨­å®šå€åŸŸ -->
      <div id="snakeLadderSettings" style="display: none; margin-top: 15px; margin-bottom: 25px; padding: 15px; background: linear-gradient(135deg, #fff5e8 0%, #ffe8d1 100%); border-radius: 12px; border-left: 4px solid #f5576c;">
        <h3 style="margin-top: 0; color: #f5576c;">ğŸğŸªœ è›‡æ¢¯è¨­å®š</h3>
        <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">éŠæˆ²å¾ä¸Šå¾€ä¸‹èµ°ï¼Œæ•¸å­—è¶Šå°è¶Šæ¥è¿‘çµ‚é»</p>
        <div class="input-group">
          <label>ğŸªœ æ¢¯å­æ•¸é‡ï¼ˆå¾€ä¸‹æ»‘ï¼ŒåŠ é€Ÿå‰é€² â¬‡ï¸ï¼‰</label>
          <input type="number" id="ladderCount" min="0" max="10" value="1">
        </div>
        <div class="input-group">
          <label>ğŸ è›‡æ•¸é‡ï¼ˆå¾€ä¸Šçˆ¬ï¼Œå¾Œé€€æ‡²ç½° â¬†ï¸ï¼‰</label>
          <input type="number" id="snakeCount" min="0" max="10" value="1">
        </div>
        <button class="btn btn-small" onclick="generateSnakeLadderInputs()" style="background: linear-gradient(135deg, #f093fb, #f5576c);">ç”¢ç”Ÿè›‡æ¢¯è¨­å®šæ¬„ä½</button>
        <div id="snakeLadderInputs" style="margin-top: 15px;"></div>
      </div>

      <button class="btn btn-small" onclick="generateTaskInputs()">ç”¢ç”Ÿä»»å‹™è¼¸å…¥æ¬„ä½</button>
      <div id="tasksInputs" style="margin-top: 15px;"></div>
    </div>

    <div style="text-align: center; margin-top: 30px; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
      <button class="btn" onclick="startGame()">ğŸš€ é–‹å§‹éŠæˆ²</button>
      <button class="btn btn-small" onclick="exportSettings()" style="background: linear-gradient(135deg, #11998e, #38ef7d);">ğŸ“¤ åŒ¯å‡ºè¨­å®š</button>
      <button class="btn btn-small" onclick="document.getElementById('importFile').click()" style="background: linear-gradient(135deg, #eb3349, #f45c43);">ğŸ“¥ åŒ¯å…¥è¨­å®š</button>
      <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSettings(event)">
    </div>
  </div>

  <!-- ========== éŠæˆ²é é¢ ========== -->
  <div id="gamePage">
    <!-- æµ®å‹•æŒ‰éˆ• -->
    <button class="floating-button" onclick="toggleSidebar()">ğŸ²</button>

    <!-- é®ç½©å±¤ -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- ä¸»è¦éŠæˆ²å€ -->
    <div class="game-main">
      <!-- æ£‹ç›¤ -->
      <div id="boardContainer" style="position: relative;">
        <div id="board" style="position: relative; z-index: 1;"></div>
        <svg id="snakeLadderLines" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2;"></svg>
      </div>

      <!-- éª°å­æ§åˆ¶å´é‚Šæ¬„ -->
      <div class="dice-control" id="diceControlSidebar">
        <!-- å›ºå®šå€åŸŸï¼šéª°å­ -->
        <div class="dice-control-fixed">
          <div class="dice-control-header">
            <h3 style="margin: 0; color: #667eea;">éŠæˆ²æ§åˆ¶</h3>
            <button class="close-sidebar" onclick="toggleSidebar()">âœ•</button>
          </div>

          <div id="diceDisplay" onclick="rollDice()"></div>
          <div style="text-align: center; color: #999; font-size: 0.9em; margin-top: -5px;">é»æ“Šéª°å­æ“²éª°</div>
          <div id="turnInfo" style="margin-top: 15px; font-size: 1em; font-weight: bold; line-height: 1.5; text-align: center;"></div>

          <div style="border-top: 2px solid #e0e0e0; margin: 20px 0;"></div>
          <h3 style="margin: 0 0 15px 0; color: #667eea;">ç©å®¶ç‹€æ…‹</h3>
        </div>

        <!-- å¯æ»¾å‹•å€åŸŸï¼šç©å®¶ç‹€æ…‹ -->
        <div class="dice-control-scrollable">
          <div class="players-info-compact" id="playersInfo"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ä»»å‹™å½ˆçª— ========== -->
  <div id="taskModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">ğŸ¯ ä»»å‹™æŒ‘æˆ°</div>

      <!-- æŠ½å¡å€åŸŸ -->
      <div class="card-container" id="cardContainer">
        <div class="card" id="taskCard" onclick="flipCard()">
          <div class="card-inner">
            <div class="card-front">
              <div class="card-back-pattern">
                <div class="card-icon">ğŸƒ</div>
                <div class="card-hint">é»æ“ŠæŠ½å¡</div>
              </div>
            </div>
            <div class="card-back">
              <div class="card-task-content" id="taskText"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer" id="taskButtons" style="display: none;">
        <button class="btn btn-success" onclick="completeTask(true)">âœ… å®Œæˆ</button>
        <button class="btn btn-danger" onclick="completeTask(false)">âŒ å¤±æ•—</button>
      </div>
    </div>
  </div>

  <!-- ========== è›‡æ¢¯å½ˆçª— ========== -->
  <div id="snakeLadderModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header" id="snakeLadderHeader">ğŸğŸªœ è›‡æ¢¯äº‹ä»¶</div>
      <div style="padding: 30px; text-align: center; font-size: 1.1em; line-height: 1.8;" id="snakeLadderContent">
      </div>
    </div>
  </div>

  <!-- ========== çµæœé é¢ ========== -->
  <div id="resultPage">
    <div class="result-title">ğŸ† éŠæˆ²çµæŸ</div>
    <div class="winner" id="winnerText"></div>
    <div class="scoreboard" id="scoreboard"></div>
    <div style="text-align: center;">
      <button class="btn" onclick="location.reload()">ğŸ”„ é‡æ–°é–‹å§‹</button>
    </div>
  </div>
</div>

<script>
// ========== éŠæˆ²ç‹€æ…‹ ==========
let gameConfig = {
  cellCount: 30,
  playerCount: 4,
  taskSuccessScore: 10,
  tasks: [],
  hiddenMode: false
};

let players = [];
let currentPlayerIndex = 0;
let board = [];
let isRolling = false;
let visitedCells = new Set(); // è¿½è¹¤å·²è¨ªå•éçš„æ ¼å­
let diceStats = {1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0}; // éª°å­çµ±è¨ˆ
let usedTasks = new Set(); // è¿½è¹¤å·²ä½¿ç”¨çš„ä»»å‹™
let availableTasks = []; // å¯ç”¨çš„ä»»å‹™æ± 

// ========== é¡è‰²é…ç½® ==========
const PLAYER_COLORS = [
  '#E53935', // æ·±ç´…è‰²
  '#1976D2', // æ·±è—è‰²
  '#388E3C', // æ·±ç¶ è‰²
  '#F57C00', // æ·±æ©˜è‰²
  '#7B1FA2', // æ·±ç´«è‰²
  '#0097A7', // æ·±é’è‰²
  '#FF1744', // é®®ç´…è‰²
  '#F50057', // ç«ç‘°ç´…
  '#D500F9', // ç´«ç´…è‰²
  '#651FFF', // æ·±ç´«è‰²
  '#3D5AFE', // é›è—è‰²
  '#2979FF', // è—è‰²
  '#00B0FF', // æ·ºè—è‰²
  '#00E5FF', // é’è‰²
  '#1DE9B6', // ç¿ ç¶ è‰²
  '#00E676', // ç¶ è‰²
  '#76FF03', // äº®ç¶ è‰²
  '#C6FF00', // æª¸æª¬ç¶ 
  '#FFEA00', // é»ƒè‰²
  '#FFC400', // ç¥ç€è‰²
  '#FF9100', // æ©˜è‰²
  '#FF3D00', // æ·±æ©˜è‰²
  '#DD2C00', // æš—ç´…è‰²
  '#FF6E40', // æ·ºæ©˜è‰²
  '#FF5252', // ç´…è‰²
  '#E040FB', // ç´«è‰²
  '#7C4DFF', // ç´«ç¾…è˜­è‰²
  '#536DFE', // è—ç´«è‰²
  '#448AFF', // å¤©è—è‰²
  '#40C4FF'  // æ·ºè—è‰²
];

// ========== é è¨­ä»»å‹™ç¯„ä¾‹ ==========
const DEFAULT_TASKS = [
  'å”±ä¸€é¦–æ­Œçµ¦å¤§å®¶è½',
  'åš 10 å€‹æ·±è¹²',
  'èªªå‡º 5 å€‹è‹±æ–‡å–®å­—',
  'æ¨¡ä»¿ä¸€ç¨®å‹•ç‰©çš„å«è²',
  'èƒŒèª¦ä¹ä¹ä¹˜æ³•è¡¨å…¶ä¸­ä¸€æ®µ',
  'ç”¨è‹±æ–‡è‡ªæˆ‘ä»‹ç´¹',
  'èªªä¸€å€‹å†·ç¬‘è©±',
  'è·³ç¹© 20 ä¸‹',
  'åš 5 å€‹ä¼åœ°æŒºèº«',
  'èªªå‡ºä»Šå¤©å­¸åˆ°çš„ä¸€ä»¶äº‹',
  'ç•«ä¸€å€‹ç°¡å–®çš„åœ–æ¡ˆ',
  'ç”¨ä¸€éš»æ‰‹å¯«å‡ºè‡ªå·±çš„åå­—',
  'å€’æ•¸å¾ 10 æ•¸åˆ° 1',
  'åšä¸€å€‹æœ‰è¶£çš„è¡¨æƒ…ä¸¦æ‹ç…§',
  'èªªå‡º 3 ç¨®æ°´æœçš„è‹±æ–‡',
  'èµ°åˆ°æ•™å®¤æœ€é çš„è§’è½å†èµ°å›ä¾†',
  'è·Ÿå¤§å®¶åˆ†äº«ä¸€å€‹å¤¢æƒ³',
  'åš 10 ç§’çš„å¹³æ¿æ”¯æ’',
  'èªªå‡ºåœ“å‘¨ç‡å‰ 5 ä½æ•¸å­—',
  'ç”¨èº«é«”æ¯”å‡ºä¸€å€‹å­—æ¯',
  'å›ç­”ä¸€å€‹æ•¸å­¸å•é¡Œï¼š7 Ã— 8 = ?',
  'èªªå‡º 5 å€‹é¡è‰²çš„åç¨±',
  'æ¨¡ä»¿è€å¸«èªªè©±çš„æ¨£å­',
  'åœ¨ç©ºä¸­å¯«å‡ºè‡ªå·±çš„åå­—',
  'èªªå‡ºä»Šå¤©çš„æ—¥æœŸå’Œæ˜ŸæœŸå¹¾'
];

// ========== åˆå§‹åŒ–å‡½æ•¸ ==========
function generatePlayerInputs() {
  const count = parseInt(document.getElementById('playerCount').value);
  gameConfig.playerCount = count;

  const container = document.getElementById('playersInputs');
  container.innerHTML = '';

  for (let i = 0; i < count; i++) {
    const div = document.createElement('div');
    div.className = 'player-input';

    // å»ºç«‹é¡è‰²é¸æ“‡å™¨
    const colorPickerHtml = `
      <div class="color-picker" id="colorPicker${i}">
        ${PLAYER_COLORS.map((color, index) =>
          `<div class="color-option ${index === i ? 'selected' : ''}"
                style="background: ${color}"
                data-player="${i}"
                data-color="${color}"></div>`
        ).join('')}
      </div>
    `;

    div.innerHTML = `
      <div class="player-color" id="playerColor${i}" style="background: ${PLAYER_COLORS[i]}"
           onclick="toggleColorPicker(${i})" title="é»æ“Šé¸æ“‡é¡è‰²"></div>
      <div class="player-info">
        <input type="text" placeholder="ç©å®¶ ${i + 1} çš„åç¨±" id="playerName${i}" value="ç©å®¶ ${i + 1}">
        ${colorPickerHtml}
      </div>
    `;
    container.appendChild(div);
  }

  // ç¶å®šé¡è‰²é¸é …é»æ“Šäº‹ä»¶
  document.querySelectorAll('.color-option').forEach(option => {
    option.addEventListener('click', function() {
      const playerIndex = parseInt(this.dataset.player);
      const color = this.dataset.color;
      selectColor(playerIndex, color, this);
    });
  });
}

function toggleColorPicker(playerIndex) {
  const picker = document.getElementById(`colorPicker${playerIndex}`);
  // é—œé–‰å…¶ä»–æ‰€æœ‰é¸è‰²å™¨
  document.querySelectorAll('.color-picker').forEach(p => {
    if (p.id !== `colorPicker${playerIndex}`) {
      p.classList.remove('active');
    }
  });
  // åˆ‡æ›ç•¶å‰é¸è‰²å™¨
  picker.classList.toggle('active');
}

function selectColor(playerIndex, color, optionElement) {
  // æ›´æ–°ç©å®¶é¡è‰²åœ“åœˆ
  document.getElementById(`playerColor${playerIndex}`).style.background = color;

  // æ›´æ–°é¸ä¸­ç‹€æ…‹
  const picker = document.getElementById(`colorPicker${playerIndex}`);
  picker.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
  optionElement.classList.add('selected');

  // é—œé–‰é¸è‰²å™¨
  picker.classList.remove('active');
}

function generateTaskInputs() {
  const count = parseInt(document.getElementById('taskCount').value);
  const container = document.getElementById('tasksInputs');
  container.innerHTML = '';

  // å˜—è©¦å¾ localStorage è¼‰å…¥ä»»å‹™
  const savedTasks = loadTasksFromStorage();

  // éš¨æ©Ÿæ‰“äº‚é è¨­ä»»å‹™
  const shuffledTasks = [...DEFAULT_TASKS].sort(() => Math.random() - 0.5);

  for (let i = 0; i < count; i++) {
    const div = document.createElement('div');
    div.className = 'task-item';
    // å„ªå…ˆä½¿ç”¨å·²å„²å­˜çš„ä»»å‹™ï¼Œå¦å‰‡ä½¿ç”¨éš¨æ©Ÿä»»å‹™
    const savedTask = savedTasks && savedTasks[i];
    const defaultTaskText = savedTask?.text || shuffledTasks[i % shuffledTasks.length];
    const defaultTaskPoints = savedTask?.points || 10;

    div.innerHTML = `
      <label><strong>ä»»å‹™ ${i + 1}</strong> (æœ€å¤š 100 å­—)</label>
      <textarea id="task${i}" maxlength="100" placeholder="ä¾‹å¦‚ï¼šå”±ä¸€é¦–æ­Œã€åš 10 å€‹æ·±è¹²ã€å›ç­”ä¸€å€‹å•é¡Œç­‰...">${defaultTaskText}</textarea>
      <div class="task-points-input">
        <label>å®Œæˆåˆ†æ•¸ï¼š</label>
        <input type="number" id="taskPoints${i}" min="1" max="100" value="${defaultTaskPoints}" placeholder="åˆ†æ•¸">
        <span>åˆ†</span>
      </div>
    `;
    container.appendChild(div);
  }
}

// åˆ‡æ›è›‡æ¢¯è¨­å®šå€åŸŸé¡¯ç¤º
function toggleSnakeLadderSettings() {
  const checkbox = document.getElementById('snakeLadderMode');
  const settings = document.getElementById('snakeLadderSettings');
  settings.style.display = checkbox.checked ? 'block' : 'none';
}

// ç”Ÿæˆè›‡æ¢¯è¨­å®šæ¬„ä½
function generateSnakeLadderInputs() {
  const ladderCount = parseInt(document.getElementById('ladderCount').value);
  const snakeCount = parseInt(document.getElementById('snakeCount').value);
  const container = document.getElementById('snakeLadderInputs');
  const cellCount = parseInt(document.getElementById('cellCount').value);

  container.innerHTML = '';

  // ç”Ÿæˆæ¢¯å­è¨­å®š
  if (ladderCount > 0) {
    const ladderSection = document.createElement('div');
    ladderSection.innerHTML = '<h4 style="color: #11998e; margin-top: 0;">ğŸªœ æ¢¯å­è¨­å®šï¼ˆå¾€ä¸‹æ»‘ï¼ŒåŠ é€Ÿå‰é€²ï¼‰</h4>';

    for (let i = 0; i < ladderCount; i++) {
      const div = document.createElement('div');
      div.className = 'task-item';
      div.style.background = 'linear-gradient(135deg, #e8fff5 0%, #d1f5e8 100%)';
      div.style.borderLeft = '4px solid #11998e';

      // éš¨æ©Ÿç”Ÿæˆæ¢¯å­çš„èµ·é»ï¼ˆè¼ƒå°æ•¸å­—ï¼‰å’Œçµ‚é»ï¼ˆè¼ƒå¤§æ•¸å­—ï¼‰
      const ladderFrom = Math.floor(Math.random() * (cellCount - 10 - 1 + 1)) + 1; // 1 åˆ° cellCount-10 ä¹‹é–“
      const ladderTo = Math.floor(Math.random() * (cellCount - 1 - (ladderFrom + 5) + 1)) + (ladderFrom + 5); // ladderFrom+5 åˆ° cellCount-1 ä¹‹é–“

      div.innerHTML = `
        <label><strong>æ¢¯å­ ${i + 1}</strong></label>
        <div style="display: flex; gap: 15px; align-items: center;">
          <div style="flex: 1;">
            <label style="font-size: 0.85em; color: #666;">å¾æ ¼å­ï¼ˆè¼ƒå°æ•¸å­—ï¼‰</label>
            <input type="number" id="ladder${i}From" min="1" max="${cellCount - 2}" value="${ladderFrom}" class="snake-ladder-input">
          </div>
          <div style="font-size: 2em; color: #11998e;">â¬‡ï¸</div>
          <div style="flex: 1;">
            <label style="font-size: 0.85em; color: #666;">åˆ°æ ¼å­ï¼ˆè¼ƒå¤§æ•¸å­—ï¼‰</label>
            <input type="number" id="ladder${i}To" min="2" max="${cellCount - 1}" value="${ladderTo}" class="snake-ladder-input">
          </div>
        </div>
      `;
      ladderSection.appendChild(div);
    }
    container.appendChild(ladderSection);
  }

  // ç”Ÿæˆè›‡è¨­å®š
  if (snakeCount > 0) {
    const snakeSection = document.createElement('div');
    snakeSection.innerHTML = '<h4 style="color: #f5576c; margin-top: 15px;">ğŸ è›‡è¨­å®šï¼ˆå¾€ä¸Šçˆ¬ï¼Œå¾Œé€€æ‡²ç½°ï¼‰</h4>';

    for (let i = 0; i < snakeCount; i++) {
      const div = document.createElement('div');
      div.className = 'task-item';
      div.style.background = 'linear-gradient(135deg, #fff0f0 0%, #ffe8e8 100%)';
      div.style.borderLeft = '4px solid #f5576c';

      // éš¨æ©Ÿç”Ÿæˆè›‡çš„èµ·é»ï¼ˆè¼ƒå¤§æ•¸å­—ï¼‰å’Œçµ‚é»ï¼ˆè¼ƒå°æ•¸å­—ï¼‰
      const snakeFrom = Math.floor(Math.random() * (cellCount - 10 - 5 + 1)) + 10; // 10 åˆ° cellCount-5 ä¹‹é–“
      const snakeTo = Math.floor(Math.random() * (snakeFrom - 5 - 1 + 1)) + 1; // 1 åˆ° snakeFrom-5 ä¹‹é–“

      div.innerHTML = `
        <label><strong>è›‡ ${i + 1}</strong></label>
        <div style="display: flex; gap: 15px; align-items: center;">
          <div style="flex: 1;">
            <label style="font-size: 0.85em; color: #666;">å¾æ ¼å­ï¼ˆè¼ƒå¤§æ•¸å­—ï¼‰</label>
            <input type="number" id="snake${i}From" min="2" max="${cellCount - 1}" value="${snakeFrom}" class="snake-ladder-input">
          </div>
          <div style="font-size: 2em; color: #f5576c;">â¬†ï¸</div>
          <div style="flex: 1;">
            <label style="font-size: 0.85em; color: #666;">åˆ°æ ¼å­ï¼ˆè¼ƒå°æ•¸å­—ï¼‰</label>
            <input type="number" id="snake${i}To" min="1" max="${cellCount - 2}" value="${snakeTo}" class="snake-ladder-input">
          </div>
        </div>
      `;
      snakeSection.appendChild(div);
    }
    container.appendChild(snakeSection);
  }
}

// å„²å­˜ä»»å‹™åˆ° localStorage
function saveTasksToStorage() {
  const taskCount = parseInt(document.getElementById('taskCount').value);
  const tasks = [];

  for (let i = 0; i < taskCount; i++) {
    const taskInput = document.getElementById(`task${i}`);
    const pointsInput = document.getElementById(`taskPoints${i}`);
    if (taskInput) {
      tasks.push({
        text: taskInput.value,
        points: pointsInput ? parseInt(pointsInput.value) || 10 : 10
      });
    }
  }

  localStorage.setItem('monopolyGameTasks', JSON.stringify(tasks));
  localStorage.setItem('monopolyGameTaskCount', taskCount);
}

// å¾ localStorage è¼‰å…¥ä»»å‹™
function loadTasksFromStorage() {
  try {
    const savedTasks = localStorage.getItem('monopolyGameTasks');
    if (!savedTasks) return null;

    const tasks = JSON.parse(savedTasks);
    // å…¼å®¹èˆŠæ ¼å¼ï¼ˆç´”å­—ä¸²é™£åˆ—ï¼‰
    return tasks.map(task => {
      if (typeof task === 'string') {
        return { text: task, points: 10 };
      }
      return task;
    });
  } catch (e) {
    console.error('è¼‰å…¥ä»»å‹™å¤±æ•—:', e);
    return null;
  }
}

function startGame() {
  // æ”¶é›†è¨­å®š
  gameConfig.cellCount = parseInt(document.getElementById('cellCount').value);
  gameConfig.playerCount = parseInt(document.getElementById('playerCount').value);
  gameConfig.taskSuccessScore = parseInt(document.getElementById('taskSuccessScore').value);
  gameConfig.hiddenMode = document.getElementById('hiddenMode').checked;

  // é‡ç½®å·²è¨ªå•æ ¼å­ï¼ˆèµ·é»é è¨­ç‚ºå·²è¨ªå•ï¼‰
  visitedCells = new Set([0]);

  // æ”¶é›†ç©å®¶
  players = [];
  for (let i = 0; i < gameConfig.playerCount; i++) {
    const nameInput = document.getElementById(`playerName${i}`);
    const colorElement = document.getElementById(`playerColor${i}`);
    if (!nameInput) {
      alert('è«‹å…ˆé»æ“Šã€Œç”¢ç”Ÿç©å®¶è¨­å®šæ¬„ä½ã€æŒ‰éˆ•');
      return;
    }
    players.push({
      name: nameInput.value || `ç©å®¶ ${i + 1}`,
      color: colorElement ? colorElement.style.background : PLAYER_COLORS[i],
      position: 0,
      score: 0
    });
  }

  // æ”¶é›†ä»»å‹™
  gameConfig.tasks = [];
  const taskCount = parseInt(document.getElementById('taskCount').value);
  for (let i = 0; i < taskCount; i++) {
    const taskInput = document.getElementById(`task${i}`);
    const pointsInput = document.getElementById(`taskPoints${i}`);
    if (!taskInput) {
      alert('è«‹å…ˆé»æ“Šã€Œç”¢ç”Ÿä»»å‹™è¼¸å…¥æ¬„ä½ã€æŒ‰éˆ•');
      return;
    }
    const taskText = taskInput.value.trim();
    if (taskText) {
      gameConfig.tasks.push({
        text: taskText,
        points: pointsInput ? parseInt(pointsInput.value) || 10 : 10
      });
    }
  }

  if (gameConfig.tasks.length === 0) {
    alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹ä»»å‹™ï¼');
    return;
  }

  // åˆå§‹åŒ–ä»»å‹™æ± ï¼ˆè¤‡è£½ä»»å‹™åˆ—è¡¨ï¼‰
  availableTasks = [...gameConfig.tasks];
  usedTasks = new Set();

  // æ”¶é›†è›‡æ¢¯è¨­å®š
  gameConfig.snakeLadderMode = document.getElementById('snakeLadderMode').checked;
  gameConfig.ladders = [];
  gameConfig.snakes = [];

  if (gameConfig.snakeLadderMode) {
    const ladderCount = parseInt(document.getElementById('ladderCount').value) || 0;
    const snakeCount = parseInt(document.getElementById('snakeCount').value) || 0;

    // æ”¶é›†æ¢¯å­è¨­å®šï¼ˆå¾å°åˆ°å¤§ï¼Œå¾€ä¸‹æ»‘ï¼‰
    for (let i = 0; i < ladderCount; i++) {
      const fromInput = document.getElementById(`ladder${i}From`);
      const toInput = document.getElementById(`ladder${i}To`);
      if (fromInput && toInput) {
        const from = parseInt(fromInput.value);
        const to = parseInt(toInput.value);
        if (from < to && to < gameConfig.cellCount) {
          gameConfig.ladders.push({ from, to });
        }
      }
    }

    // æ”¶é›†è›‡è¨­å®šï¼ˆå¾å¤§åˆ°å°ï¼Œå¾€ä¸Šçˆ¬ï¼‰
    for (let i = 0; i < snakeCount; i++) {
      const fromInput = document.getElementById(`snake${i}From`);
      const toInput = document.getElementById(`snake${i}To`);
      if (fromInput && toInput) {
        const from = parseInt(fromInput.value);
        const to = parseInt(toInput.value);
        if (from > to && to >= 1) {
          gameConfig.snakes.push({ from, to });
        }
      }
    }
  }

  // å„²å­˜ä»»å‹™åˆ° localStorage
  saveTasksToStorage();

  // åˆå§‹åŒ–æ£‹ç›¤
  initBoard();

  // åˆ‡æ›åˆ°éŠæˆ²é é¢
  document.getElementById('setupPage').style.display = 'none';
  document.getElementById('gamePage').style.display = 'block';

  // æ¸²æŸ“éŠæˆ²
  renderPlayersInfo();
  renderBoard();
  updateTurnInfo();

  // åˆå§‹åŒ–éª°å­é¡¯ç¤º
  const diceDisplay = document.getElementById('diceDisplay');
  const initialDice = createDice(1);
  diceDisplay.innerHTML = '';
  diceDisplay.appendChild(initialDice);

  // æ»¾å‹•åˆ°èµ·é»ä½ç½®ï¼Œè®“ç©å®¶çœ‹åˆ°æ‰€æœ‰äººåœ¨å“ªè£¡
  setTimeout(() => {
    scrollToCurrentPlayer();
  }, 100);
}

function initBoard() {
  board = [];
  const taskPositions = new Set();

  // æ”¶é›†æ‰€æœ‰è›‡æ¢¯ä½”ç”¨çš„æ ¼å­ä½ç½®
  const snakeLadderPositions = new Set();
  if (gameConfig.snakeLadderMode) {
    if (gameConfig.ladders) {
      gameConfig.ladders.forEach(ladder => {
        snakeLadderPositions.add(ladder.from);
        snakeLadderPositions.add(ladder.to);
      });
    }
    if (gameConfig.snakes) {
      gameConfig.snakes.forEach(snake => {
        snakeLadderPositions.add(snake.from);
        snakeLadderPositions.add(snake.to);
      });
    }
  }

  // éš¨æ©Ÿåˆ†é…ä»»å‹™ä½ç½®ï¼ˆé¿é–‹èµ·é»ã€çµ‚é»å’Œè›‡æ¢¯ä½ç½®ï¼‰
  const availablePositions = [];
  for (let i = 1; i < gameConfig.cellCount - 1; i++) {
    if (!snakeLadderPositions.has(i)) {
      availablePositions.push(i);
    }
  }

  // éš¨æ©Ÿé¸æ“‡ä»»å‹™ä½ç½®
  const taskCount = Math.min(gameConfig.tasks.length, availablePositions.length);
  for (let i = 0; i < taskCount; i++) {
    const randomIndex = Math.floor(Math.random() * availablePositions.length);
    taskPositions.add(availablePositions[randomIndex]);
    availablePositions.splice(randomIndex, 1);
  }

  // å»ºç«‹æ£‹ç›¤ï¼ˆä»»å‹™æ ¼ä¸é å…ˆåˆ†é…ä»»å‹™ï¼Œè€Œæ˜¯åœ¨è¸©åˆ°æ™‚æ‰æŠ½å–ï¼‰
  for (let i = 0; i < gameConfig.cellCount; i++) {
    if (i === 0) {
      board.push({ type: 'start', task: null });
    } else if (i === gameConfig.cellCount - 1) {
      board.push({ type: 'finish', task: null });
    } else if (taskPositions.has(i)) {
      board.push({ type: 'task', task: null }); // ä»»å‹™å¾…æŠ½å–
    } else {
      board.push({ type: 'normal', task: null });
    }
  }
}

function renderPlayersInfo() {
  const container = document.getElementById('playersInfo');
  container.innerHTML = '';

  players.forEach((player, index) => {
    const card = document.createElement('div');
    card.className = 'player-card' + (index === currentPlayerIndex ? ' active' : '');
    card.innerHTML = `
      <div class="player-card-header">
        <div class="player-icon" style="background: ${player.color}"></div>
        <div class="player-name">${player.name}</div>
      </div>
      <div class="player-score">${player.score} åˆ†</div>
    `;
    container.appendChild(card);
  });
}

function renderBoard() {
  const boardDiv = document.getElementById('board');
  boardDiv.innerHTML = '';

  // è¨ˆç®—è›‡å½¢ä½ˆå±€çš„è¡Œåˆ—
  // æ‰‹æ©Ÿç‰ˆæ™‚æ¸›å°‘åˆ—æ•¸ï¼Œé¿å…çˆ†ç‰ˆ
  const isMobile = window.innerWidth <= 768;
  let cols;

  if (isMobile) {
    // æ‰‹æ©Ÿç‰ˆï¼šå›ºå®š 4 åˆ—
    cols = Math.min(4, Math.ceil(Math.sqrt(gameConfig.cellCount)));
  } else {
    // æ¡Œé¢ç‰ˆï¼šä½¿ç”¨å¹³æ–¹æ ¹è¨ˆç®—
    cols = Math.ceil(Math.sqrt(gameConfig.cellCount));
  }

  const rows = Math.ceil(gameConfig.cellCount / cols);

  boardDiv.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

  // è›‡å½¢æ’åˆ—
  const snakeOrder = [];
  for (let row = rows - 1; row >= 0; row--) {
    if ((rows - 1 - row) % 2 === 0) {
      // å¾å·¦åˆ°å³
      for (let col = 0; col < cols; col++) {
        const index = row * cols + col;
        if (index < gameConfig.cellCount) {
          snakeOrder.push(index);
        }
      }
    } else {
      // å¾å³åˆ°å·¦
      for (let col = cols - 1; col >= 0; col--) {
        const index = row * cols + col;
        if (index < gameConfig.cellCount) {
          snakeOrder.push(index);
        }
      }
    }
  }

  // åè½‰é †åºï¼ˆå¾ä¸‹å¾€ä¸Šï¼‰
  snakeOrder.reverse();

  // å‰µå»ºæ ¼å­
  snakeOrder.forEach((cellIndex, displayIndex) => {
    const cell = board[cellIndex];
    const div = document.createElement('div');
    div.className = 'cell';
    div.setAttribute('data-cell-index', cellIndex); // åŠ å…¥æ ¼å­ç·¨è™Ÿæ¨™è¨˜

    // è¨ˆç®—é€™å€‹æ ¼å­åœ¨ç¬¬å¹¾è¡Œï¼ˆå¾ä¸‹å¾€ä¸Šï¼‰
    const row = Math.floor(displayIndex / cols);
    const col = displayIndex % cols;
    const isRightToLeft = row % 2 === 1;
    const isLastRowIncomplete = gameConfig.cellCount % cols !== 0 && row === rows - 1;

    // å¦‚æœæ˜¯æœ€å¾Œä¸€è¡Œä¸”ä¸å®Œæ•´ï¼Œéœ€è¦èª¿æ•´gridä½ç½®
    if (isLastRowIncomplete) {
      const cellsInLastRow = gameConfig.cellCount % cols;
      if (!isRightToLeft) {
        // å¾å·¦åˆ°å³çš„è¡Œï¼Œé å³å°é½Š
        div.style.gridColumnStart = cols - cellsInLastRow + col + 1;
      }
      // å¾å³åˆ°å·¦çš„è¡Œï¼Œè‡ªç„¶é å³å°é½Šï¼Œä¸éœ€è¦é¡å¤–è¨­å®š
    }

    // æª¢æŸ¥æ˜¯å¦éœ€è¦è¿·éœ§é®è“‹ï¼ˆéš±è—æ¨¡å¼ä¸”è©²æ ¼å­æœªè¢«è¨ªå•ï¼‰
    const isFogCovered = gameConfig.hiddenMode && !visitedCells.has(cellIndex);

    // æª¢æŸ¥æ˜¯å¦æœ‰è›‡æˆ–æ¢¯å­
    let snakeLadderIcon = '';
    if (gameConfig.snakeLadderMode) {
      // æª¢æŸ¥æ¢¯å­ï¼ˆå¾å°åˆ°å¤§ï¼‰
      for (const ladder of gameConfig.ladders || []) {
        if (ladder.from === cellIndex) {
          snakeLadderIcon = `<div style="font-size: 1.2em; position: absolute; top: 5px; right: 5px; background: rgba(17, 153, 142, 0.2); padding: 3px 6px; border-radius: 5px;">ğŸªœâ†’${ladder.to}</div>`;
          break;
        }
      }
      // æª¢æŸ¥è›‡ï¼ˆå¾å¤§åˆ°å°ï¼‰
      if (!snakeLadderIcon) {
        for (const snake of gameConfig.snakes || []) {
          if (snake.from === cellIndex) {
            snakeLadderIcon = `<div style="font-size: 1.2em; position: absolute; top: 5px; right: 5px; background: rgba(245, 87, 108, 0.2); padding: 3px 6px; border-radius: 5px;">ğŸâ†’${snake.to}</div>`;
            break;
          }
        }
      }
    }

    if (cell.type === 'start') {
      div.classList.add('start');
      div.innerHTML = `<div class="cell-number">${cellIndex}</div><div>ğŸ  èµ·é»</div>${snakeLadderIcon}`;
    } else if (cell.type === 'finish') {
      div.classList.add('finish');
      div.innerHTML = `<div class="cell-number">${cellIndex}</div><div>ğŸ çµ‚é»</div>${snakeLadderIcon}`;
    } else if (cell.type === 'task') {
      div.classList.add('has-task');
      div.innerHTML = `<div class="cell-number">${cellIndex}</div><div style="font-size: 2.5em;">ğŸ“‹</div>${snakeLadderIcon}`;
    } else {
      div.innerHTML = `<div class="cell-number">${cellIndex}</div>${snakeLadderIcon}`;
    }

    // æ·»åŠ è¿·éœ§é®è“‹æ¨£å¼
    if (isFogCovered) {
      div.classList.add('fog-covered');
    }

    // æ·»åŠ ç•¶å‰æ ¼å­é«˜äº®
    players.forEach(player => {
      if (player.position === cellIndex) {
        div.classList.add('current');
      }
    });

    // æ·»åŠ ç©å®¶æ¨™è¨˜
    const playersDiv = document.createElement('div');
    playersDiv.className = 'cell-players';
    players.forEach((player, index) => {
      if (player.position === cellIndex) {
        const token = document.createElement('div');
        token.className = 'player-token';
        // å¦‚æœæ˜¯ç•¶å‰è¼ªåˆ°çš„ç©å®¶ï¼ŒåŠ ä¸Š current-turn class
        if (index === currentPlayerIndex) {
          token.classList.add('current-turn');
        }
        token.style.background = player.color;
        token.title = player.name;
        token.textContent = player.name.charAt(0); // é¡¯ç¤ºåç¨±ç¬¬ä¸€å€‹å­—
        playersDiv.appendChild(token);
      }
    });
    div.appendChild(playersDiv);

    boardDiv.appendChild(div);
  });

  // ç¹ªè£½è›‡æ¢¯é€£æ¥ç·šï¼ˆå»¶é²åŸ·è¡Œä»¥ç¢ºä¿æ ¼å­å·²æ¸²æŸ“ï¼‰
  setTimeout(() => {
    drawSnakeLadderLines();
  }, 100);
}

// ç¹ªè£½è›‡æ¢¯é€£æ¥ç·š
function drawSnakeLadderLines() {
  const svg = document.getElementById('snakeLadderLines');
  if (!svg || !gameConfig.snakeLadderMode) {
    if (svg) svg.innerHTML = '';
    return;
  }

  svg.innerHTML = '';

  // æ›´æ–° SVG å°ºå¯¸ä»¥åŒ¹é…æ£‹ç›¤å®¹å™¨
  const boardContainer = document.getElementById('boardContainer');
  if (boardContainer) {
    const rect = boardContainer.getBoundingClientRect();
    svg.setAttribute('width', rect.width);
    svg.setAttribute('height', rect.height);
    svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
  }

  if (document.querySelectorAll('#board .cell').length === 0) {
    console.warn('æ²’æœ‰æ‰¾åˆ°æ£‹ç›¤æ ¼å­');
    return;
  }

  // ç¹ªè£½æ¢¯å­é€£æ¥ç·š
  if (gameConfig.ladders && gameConfig.ladders.length > 0) {
    console.log('ç¹ªè£½æ¢¯å­:', gameConfig.ladders);
    gameConfig.ladders.forEach(ladder => {
      const fromCell = document.querySelector(`#board .cell[data-cell-index="${ladder.from}"]`);
      const toCell = document.querySelector(`#board .cell[data-cell-index="${ladder.to}"]`);
      if (fromCell && toCell) {
        drawCurvedLine(svg, fromCell, toCell, '#11998e', 'ğŸªœ');
      } else {
        console.warn('æ‰¾ä¸åˆ°æ¢¯å­çš„æ ¼å­:', ladder, 'from:', fromCell, 'to:', toCell);
      }
    });
  }

  // ç¹ªè£½è›‡é€£æ¥ç·š
  if (gameConfig.snakes && gameConfig.snakes.length > 0) {
    console.log('ç¹ªè£½è›‡:', gameConfig.snakes);
    gameConfig.snakes.forEach(snake => {
      const fromCell = document.querySelector(`#board .cell[data-cell-index="${snake.from}"]`);
      const toCell = document.querySelector(`#board .cell[data-cell-index="${snake.to}"]`);
      if (fromCell && toCell) {
        drawCurvedLine(svg, fromCell, toCell, '#f5576c', 'ğŸ');
      } else {
        console.warn('æ‰¾ä¸åˆ°è›‡çš„æ ¼å­:', snake, 'from:', fromCell, 'to:', toCell);
      }
    });
  }
}

// ç¹ªè£½æ¢¯å­æˆ–è›‡çš„åœ–æ¡ˆé€£æ¥å…©å€‹æ ¼å­
function drawCurvedLine(svg, fromCell, toCell, color, icon) {
  const fromRect = fromCell.getBoundingClientRect();
  const toRect = toCell.getBoundingClientRect();
  const containerRect = document.getElementById('boardContainer').getBoundingClientRect();

  // è¨ˆç®—èµ·é»å’Œçµ‚é»çš„ä¸­å¿ƒä½ç½®ï¼ˆç›¸å°æ–¼ boardContainerï¼‰
  const x1 = fromRect.left + fromRect.width / 2 - containerRect.left;
  const y1 = fromRect.top + fromRect.height / 2 - containerRect.top;
  const x2 = toRect.left + toRect.width / 2 - containerRect.left;
  const y2 = toRect.top + toRect.height / 2 - containerRect.top;

  // åˆ¤æ–·æ˜¯æ¢¯å­é‚„æ˜¯è›‡
  const isLadder = icon === 'ğŸªœ';

  if (isLadder) {
    // ç•«æ¢¯å­
    drawLadder(svg, x1, y1, x2, y2, color);
  } else {
    // ç•«è›‡
    drawSnake(svg, x1, y1, x2, y2, color);
  }
}

// ç¹ªè£½æ¢¯å­åœ–æ¡ˆï¼ˆç«‹é«”æœ¨æ¢¯é¢¨æ ¼ï¼‰
function drawLadder(svg, x1, y1, x2, y2, color) {
  const dx = x2 - x1;
  const dy = y2 - y1;
  const length = Math.sqrt(dx * dx + dy * dy);
  const angle = Math.atan2(dy, dx);

  // æ¢¯å­çš„å¯¬åº¦
  const ladderWidth = 25;

  // è¨ˆç®—æ¢¯å­å…©å´çš„ä½ç½®
  const perpX = -Math.sin(angle) * ladderWidth / 2;
  const perpY = Math.cos(angle) * ladderWidth / 2;

  // å‰µå»ºæ¼¸å±¤ï¼ˆæœ¨é ­è³ªæ„Ÿï¼‰
  const gradientId = `ladder-gradient-${Math.random().toString(36).substr(2, 9)}`;
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradient.setAttribute('id', gradientId);
  gradient.setAttribute('x1', '0%');
  gradient.setAttribute('y1', '0%');
  gradient.setAttribute('x2', '100%');
  gradient.setAttribute('y2', '0%');

  const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  stop1.setAttribute('offset', '0%');
  stop1.setAttribute('stop-color', '#CD853F');

  const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  stop2.setAttribute('offset', '50%');
  stop2.setAttribute('stop-color', '#DEB887');

  const stop3 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
  stop3.setAttribute('offset', '100%');
  stop3.setAttribute('stop-color', '#CD853F');

  gradient.appendChild(stop1);
  gradient.appendChild(stop2);
  gradient.appendChild(stop3);
  defs.appendChild(gradient);
  svg.appendChild(defs);

  // å·¦å´æ”¯æŸ±ï¼ˆå¸¶é™°å½±æ•ˆæœï¼‰
  const leftShadow = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  leftShadow.setAttribute('x1', x1 + perpX + 2);
  leftShadow.setAttribute('y1', y1 + perpY + 2);
  leftShadow.setAttribute('x2', x2 + perpX + 2);
  leftShadow.setAttribute('y2', y2 + perpY + 2);
  leftShadow.setAttribute('stroke', 'rgba(0,0,0,0.3)');
  leftShadow.setAttribute('stroke-width', '8');
  leftShadow.setAttribute('stroke-linecap', 'round');
  svg.appendChild(leftShadow);

  const leftLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  leftLine.setAttribute('x1', x1 + perpX);
  leftLine.setAttribute('y1', y1 + perpY);
  leftLine.setAttribute('x2', x2 + perpX);
  leftLine.setAttribute('y2', y2 + perpY);
  leftLine.setAttribute('stroke', `url(#${gradientId})`);
  leftLine.setAttribute('stroke-width', '8');
  leftLine.setAttribute('stroke-linecap', 'round');
  svg.appendChild(leftLine);

  // å³å´æ”¯æŸ±ï¼ˆå¸¶é™°å½±æ•ˆæœï¼‰
  const rightShadow = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  rightShadow.setAttribute('x1', x1 - perpX + 2);
  rightShadow.setAttribute('y1', y1 - perpY + 2);
  rightShadow.setAttribute('x2', x2 - perpX + 2);
  rightShadow.setAttribute('y2', y2 - perpY + 2);
  rightShadow.setAttribute('stroke', 'rgba(0,0,0,0.3)');
  rightShadow.setAttribute('stroke-width', '8');
  rightShadow.setAttribute('stroke-linecap', 'round');
  svg.appendChild(rightShadow);

  const rightLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  rightLine.setAttribute('x1', x1 - perpX);
  rightLine.setAttribute('y1', y1 - perpY);
  rightLine.setAttribute('x2', x2 - perpX);
  rightLine.setAttribute('y2', y2 - perpY);
  rightLine.setAttribute('stroke', `url(#${gradientId})`);
  rightLine.setAttribute('stroke-width', '8');
  rightLine.setAttribute('stroke-linecap', 'round');
  svg.appendChild(rightLine);

  // æ©«æ§“æ•¸é‡ï¼ˆæ ¹æ“šé•·åº¦æ±ºå®šï¼‰
  const rungCount = Math.max(4, Math.floor(length / 35));

  // ç¹ªè£½æ©«æ§“
  for (let i = 1; i < rungCount; i++) {
    const t = i / rungCount;
    const rungX = x1 + dx * t;
    const rungY = y1 + dy * t;

    // æ©«æ§“é™°å½±
    const rungShadow = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    rungShadow.setAttribute('x1', rungX + perpX + 2);
    rungShadow.setAttribute('y1', rungY + perpY + 2);
    rungShadow.setAttribute('x2', rungX - perpX + 2);
    rungShadow.setAttribute('y2', rungY - perpY + 2);
    rungShadow.setAttribute('stroke', 'rgba(0,0,0,0.3)');
    rungShadow.setAttribute('stroke-width', '7');
    rungShadow.setAttribute('stroke-linecap', 'round');
    svg.appendChild(rungShadow);

    const rung = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    rung.setAttribute('x1', rungX + perpX);
    rung.setAttribute('y1', rungY + perpY);
    rung.setAttribute('x2', rungX - perpX);
    rung.setAttribute('y2', rungY - perpY);
    rung.setAttribute('stroke', `url(#${gradientId})`);
    rung.setAttribute('stroke-width', '7');
    rung.setAttribute('stroke-linecap', 'round');
    svg.appendChild(rung);
  }
}

// ç¹ªè£½è›‡åœ–æ¡ˆï¼ˆå½©è‰²æ³¢æµªè›‡ï¼‰
function drawSnake(svg, x1, y1, x2, y2, color) {
  const dx = x2 - x1;
  const dy = y2 - y1;
  const distance = Math.sqrt(dx * dx + dy * dy);
  const baseAngle = Math.atan2(dy, dx);

  // ä½¿ç”¨æ­£å¼¦æ³¢å‰µå»ºè›‡çš„èº«é«”
  const segments = Math.max(30, Math.floor(distance / 8));
  const points = [];

  for (let i = 0; i <= segments; i++) {
    const t = i / segments;
    const x = x1 + dx * t;
    const y = y1 + dy * t;

    // æ·»åŠ æ³¢æµªæ•ˆæœï¼ˆSå‹æ›²ç·šï¼‰
    const perpAngle = baseAngle + Math.PI / 2;
    const waveAmplitude = 18 * Math.sin(t * Math.PI * 5); // 5å€‹æ³¢æµªé€±æœŸ
    const offsetX = Math.cos(perpAngle) * waveAmplitude;
    const offsetY = Math.sin(perpAngle) * waveAmplitude;

    points.push({ x: x + offsetX, y: y + offsetY, t });
  }

  // å‰µå»ºæ¼¸å±¤ï¼ˆå½©è‰²è›‡èº«ï¼‰
  const gradientId = `snake-gradient-${Math.random().toString(36).substr(2, 9)}`;
  const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
  const gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
  gradient.setAttribute('id', gradientId);
  gradient.setAttribute('x1', '0%');
  gradient.setAttribute('y1', '0%');
  gradient.setAttribute('x2', '100%');
  gradient.setAttribute('y2', '0%');

  // å½©è‰²æ¼¸å±¤ï¼ˆç¶ è‰²åˆ°é»ƒè‰²åˆ°ç´…è‰²ï¼‰
  const colors = [
    { offset: '0%', color: '#228B22' },
    { offset: '33%', color: '#90EE90' },
    { offset: '66%', color: '#FFD700' },
    { offset: '100%', color: '#FF6347' }
  ];

  colors.forEach(c => {
    const stop = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
    stop.setAttribute('offset', c.offset);
    stop.setAttribute('stop-color', c.color);
    gradient.appendChild(stop);
  });

  defs.appendChild(gradient);
  svg.appendChild(defs);

  // ç¹ªè£½è›‡èº«é™°å½±
  let shadowPath = `M ${points[0].x + 2} ${points[0].y + 2}`;
  for (let i = 1; i < points.length; i++) {
    shadowPath += ` L ${points[i].x + 2} ${points[i].y + 2}`;
  }

  const shadow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  shadow.setAttribute('d', shadowPath);
  shadow.setAttribute('stroke', 'rgba(0,0,0,0.3)');
  shadow.setAttribute('stroke-width', '14');
  shadow.setAttribute('fill', 'none');
  shadow.setAttribute('stroke-linecap', 'round');
  shadow.setAttribute('stroke-linejoin', 'round');
  svg.appendChild(shadow);

  // ç¹ªè£½è›‡èº«ä¸»é«”
  let pathData = `M ${points[0].x} ${points[0].y}`;
  for (let i = 1; i < points.length; i++) {
    pathData += ` L ${points[i].x} ${points[i].y}`;
  }

  const snakePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
  snakePath.setAttribute('d', pathData);
  snakePath.setAttribute('stroke', `url(#${gradientId})`);
  snakePath.setAttribute('stroke-width', '12');
  snakePath.setAttribute('fill', 'none');
  snakePath.setAttribute('stroke-linecap', 'round');
  snakePath.setAttribute('stroke-linejoin', 'round');
  svg.appendChild(snakePath);

  // è›‡é ­ï¼ˆèµ·é» x1,y1 = è¼ƒå¤§æ•¸å­—æ ¼å­ï¼‰
  const headX = points[0].x;
  const headY = points[0].y;

  // è¨ˆç®—è›‡é ­çš„æ–¹å‘ï¼ˆå¾èµ·é»å¾€å›çœ‹ç¬¬äºŒå€‹é»ï¼Œç„¶å¾Œåå‘180åº¦ï¼‰
  const bodyAngle = Math.atan2(points[1].y - headY, points[1].x - headX);
  const headAngle = bodyAngle + Math.PI; // åŠ 180åº¦è®“é ­æœå‘åæ–¹å‘

  // è›‡é ­é™°å½±
  const headShadow = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
  headShadow.setAttribute('cx', headX + 2);
  headShadow.setAttribute('cy', headY + 2);
  headShadow.setAttribute('rx', '14');
  headShadow.setAttribute('ry', '11');
  headShadow.setAttribute('transform', `rotate(${headAngle * 180 / Math.PI} ${headX + 2} ${headY + 2})`);
  headShadow.setAttribute('fill', 'rgba(0,0,0,0.3)');
  svg.appendChild(headShadow);

  // è›‡é ­ä¸»é«”ï¼ˆæ©¢åœ“å½¢ï¼‰
  const headEllipse = document.createElementNS('http://www.w3.org/2000/svg', 'ellipse');
  headEllipse.setAttribute('cx', headX);
  headEllipse.setAttribute('cy', headY);
  headEllipse.setAttribute('rx', '14');
  headEllipse.setAttribute('ry', '11');
  headEllipse.setAttribute('transform', `rotate(${headAngle * 180 / Math.PI} ${headX} ${headY})`);
  headEllipse.setAttribute('fill', '#FF4500');
  svg.appendChild(headEllipse);

  // è¨ˆç®—çœ¼ç›ä½ç½®ï¼ˆç›¸å°æ–¼è›‡é ­æ–¹å‘ï¼‰
  const eyeOffsetX = Math.cos(headAngle) * 5;
  const eyeOffsetY = Math.sin(headAngle) * 5;
  const eyePerpX = -Math.sin(headAngle) * 5;
  const eyePerpY = Math.cos(headAngle) * 5;

  // å·¦çœ¼ç™½è‰²éƒ¨åˆ†
  const eye1White = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  eye1White.setAttribute('cx', headX + eyeOffsetX + eyePerpX);
  eye1White.setAttribute('cy', headY + eyeOffsetY + eyePerpY);
  eye1White.setAttribute('r', '3');
  eye1White.setAttribute('fill', 'white');
  svg.appendChild(eye1White);

  // å·¦çœ¼é»‘è‰²ç³å­”
  const eye1Black = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  eye1Black.setAttribute('cx', headX + eyeOffsetX + eyePerpX + 1);
  eye1Black.setAttribute('cy', headY + eyeOffsetY + eyePerpY);
  eye1Black.setAttribute('r', '1.5');
  eye1Black.setAttribute('fill', 'black');
  svg.appendChild(eye1Black);

  // å³çœ¼ç™½è‰²éƒ¨åˆ†
  const eye2White = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  eye2White.setAttribute('cx', headX + eyeOffsetX - eyePerpX);
  eye2White.setAttribute('cy', headY + eyeOffsetY - eyePerpY);
  eye2White.setAttribute('r', '3');
  eye2White.setAttribute('fill', 'white');
  svg.appendChild(eye2White);

  // å³çœ¼é»‘è‰²ç³å­”
  const eye2Black = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  eye2Black.setAttribute('cx', headX + eyeOffsetX - eyePerpX + 1);
  eye2Black.setAttribute('cy', headY + eyeOffsetY - eyePerpY);
  eye2Black.setAttribute('r', '1.5');
  eye2Black.setAttribute('fill', 'black');
  svg.appendChild(eye2Black);

  // è›‡å˜´ï¼ˆå°–ç«¯ï¼‰
  const mouthX = headX + Math.cos(headAngle) * 14;
  const mouthY = headY + Math.sin(headAngle) * 14;

  const mouth = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  mouth.setAttribute('cx', mouthX);
  mouth.setAttribute('cy', mouthY);
  mouth.setAttribute('r', '3');
  mouth.setAttribute('fill', '#8B0000');
  svg.appendChild(mouth);

  // è›‡ä¿¡ï¼ˆåˆ†å‰çš„èˆŒé ­ï¼‰
  const tongueX = mouthX + Math.cos(headAngle) * 3;
  const tongueY = mouthY + Math.sin(headAngle) * 3;
  const tonguePerpX = -Math.sin(headAngle) * 2;
  const tonguePerpY = Math.cos(headAngle) * 2;

  // èˆŒé ­ä¸»å¹¹
  const tongueMain = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  tongueMain.setAttribute('x1', mouthX);
  tongueMain.setAttribute('y1', mouthY);
  tongueMain.setAttribute('x2', tongueX + Math.cos(headAngle) * 8);
  tongueMain.setAttribute('y2', tongueY + Math.sin(headAngle) * 8);
  tongueMain.setAttribute('stroke', '#FF1493');
  tongueMain.setAttribute('stroke-width', '2');
  tongueMain.setAttribute('stroke-linecap', 'round');
  svg.appendChild(tongueMain);

  // èˆŒé ­å·¦åˆ†å‰
  const tongueTipX = tongueX + Math.cos(headAngle) * 8;
  const tongueTipY = tongueY + Math.sin(headAngle) * 8;

  const tongueLeft = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  tongueLeft.setAttribute('x1', tongueTipX);
  tongueLeft.setAttribute('y1', tongueTipY);
  tongueLeft.setAttribute('x2', tongueTipX + Math.cos(headAngle - 0.3) * 4 + tonguePerpX);
  tongueLeft.setAttribute('y2', tongueTipY + Math.sin(headAngle - 0.3) * 4 + tonguePerpY);
  tongueLeft.setAttribute('stroke', '#FF1493');
  tongueLeft.setAttribute('stroke-width', '1.5');
  tongueLeft.setAttribute('stroke-linecap', 'round');
  svg.appendChild(tongueLeft);

  // èˆŒé ­å³åˆ†å‰
  const tongueRight = document.createElementNS('http://www.w3.org/2000/svg', 'line');
  tongueRight.setAttribute('x1', tongueTipX);
  tongueRight.setAttribute('y1', tongueTipY);
  tongueRight.setAttribute('x2', tongueTipX + Math.cos(headAngle + 0.3) * 4 - tonguePerpX);
  tongueRight.setAttribute('y2', tongueTipY + Math.sin(headAngle + 0.3) * 4 - tonguePerpY);
  tongueRight.setAttribute('stroke', '#FF1493');
  tongueRight.setAttribute('stroke-width', '1.5');
  tongueRight.setAttribute('stroke-linecap', 'round');
  svg.appendChild(tongueRight);

  // è›‡å°¾ï¼ˆçµ‚é» x2,y2 = è¼ƒå°æ•¸å­—æ ¼å­ï¼‰
  const tailX = points[points.length - 1].x;
  const tailY = points[points.length - 1].y;

  const tailCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
  tailCircle.setAttribute('cx', tailX);
  tailCircle.setAttribute('cy', tailY);
  tailCircle.setAttribute('r', '6');
  tailCircle.setAttribute('fill', '#228B22');
  svg.appendChild(tailCircle);
}

function updateTurnInfo() {
  const info = document.getElementById('turnInfo');
  info.innerHTML = `è¼ªåˆ° <span style="color: ${players[currentPlayerIndex].color}">${players[currentPlayerIndex].name}</span> æ“²éª°å­`;
}

function scrollToCurrentPlayer() {
  const player = players[currentPlayerIndex];
  // ä½¿ç”¨ data-cell-index ä¾†æ‰¾åˆ°æ­£ç¢ºçš„æ ¼å­
  const currentCell = document.querySelector(`#board .cell[data-cell-index="${player.position}"]`);

  if (currentCell) {
    currentCell.scrollIntoView({
      behavior: 'smooth',
      block: 'center',
      inline: 'center'
    });
  }
}

// ========== 3D éª°å­å‡½æ•¸ ==========
function createDice(number) {
  const dice = document.createElement('div');
  dice.className = 'dice-3d';

  // éª°å­çš„ 6 å€‹é¢
  const faces = [
    { name: 'front', dots: 1 },
    { name: 'back', dots: 6 },
    { name: 'right', dots: 3 },
    { name: 'left', dots: 4 },
    { name: 'top', dots: 5 },
    { name: 'bottom', dots: 2 }
  ];

  faces.forEach(face => {
    const faceDiv = document.createElement('div');
    faceDiv.className = `dice-face ${face.name} face-${face.dots}`;

    // æ ¹æ“šé»æ•¸æ·»åŠ åœ“é»
    for (let i = 0; i < face.dots; i++) {
      const dot = document.createElement('div');
      dot.className = 'dice-dot';
      faceDiv.appendChild(dot);
    }

    dice.appendChild(faceDiv);
  });

  return dice;
}

function getDiceRotation(number) {
  // æ ¹æ“šé»æ•¸è¿”å›å°æ‡‰çš„æ—‹è½‰è§’åº¦
  const rotations = {
    1: 'rotateX(0deg) rotateY(0deg)',      // æ­£é¢ = 1
    2: 'rotateX(90deg) rotateY(0deg)',     // é ‚éƒ¨ = 5 (è¦é¡¯ç¤ºåº•éƒ¨2)
    3: 'rotateX(0deg) rotateY(-90deg)',    // å·¦å´ = 4 (è¦é¡¯ç¤ºå³å´3)
    4: 'rotateX(0deg) rotateY(90deg)',     // å³å´ = 3 (è¦é¡¯ç¤ºå·¦å´4)
    5: 'rotateX(-90deg) rotateY(0deg)',    // åº•éƒ¨ = 2 (è¦é¡¯ç¤ºé ‚éƒ¨5)
    6: 'rotateX(0deg) rotateY(180deg)'     // èƒŒé¢ = 6
  };
  return rotations[number];
}

// ========== éŠæˆ²é‚è¼¯ ==========
function rollDice() {
  if (isRolling) return;
  isRolling = true;

  // ç¦ç”¨éª°å­é»æ“Š
  const diceDisplay = document.getElementById('diceDisplay');
  diceDisplay.classList.add('disabled');

  // å»ºç«‹ 3D éª°å­
  const dice = createDice(1);
  diceDisplay.innerHTML = '';
  diceDisplay.appendChild(dice);

  // æ·»åŠ æ»¾å‹•å‹•ç•«
  dice.classList.add('rolling');

  // éš¨æ©Ÿæœ€çµ‚é»æ•¸
  const finalNumber = Math.floor(Math.random() * 6) + 1;

  // çµ±è¨ˆéª°å­çµæœ
  diceStats[finalNumber]++;
  const totalRolls = Object.values(diceStats).reduce((a, b) => a + b, 0);
  console.log(`éª°å­çµæœ: ${finalNumber} | çµ±è¨ˆ:`, diceStats, `| ç¸½æ¬¡æ•¸: ${totalRolls}`);

  // å‹•ç•«çµæŸå¾Œé¡¯ç¤ºçµæœï¼ˆ0.6ç§’ï¼‰
  setTimeout(() => {
    dice.classList.remove('rolling');
    dice.style.transform = getDiceRotation(finalNumber);

    // çŸ­æš«å»¶é²å¾Œé—œé–‰å´é‚Šæ¬„ä¸¦ç§»å‹•ç©å®¶
    setTimeout(() => {
      // é—œé–‰å´é‚Šæ¬„
      toggleSidebar();

      // å†å»¶é²ä¸€ä¸‹è®“å´é‚Šæ¬„å‹•ç•«å®Œæˆå¾Œæ‰ç§»å‹•ç©å®¶å’Œæ»¾å‹•åˆ°ä½ç½®
      setTimeout(() => {
        // å…ˆæ»¾å‹•åˆ°ç•¶å‰ç©å®¶ä½ç½®
        scrollToCurrentPlayer();

        // ç¨å¾®å»¶é²å¾Œé–‹å§‹ç§»å‹•ç©å®¶
        setTimeout(() => {
          movePlayer(finalNumber);
        }, 200);
      }, 300);
    }, 400);
  }, 600);
}

function movePlayer(steps) {
  const player = players[currentPlayerIndex];
  const targetPosition = Math.min(player.position + steps, gameConfig.cellCount - 1);

  // é€æ­¥ç§»å‹•å‹•ç•«
  let currentStep = 0;
  const moveInterval = setInterval(() => {
    if (currentStep < steps && player.position < gameConfig.cellCount - 1) {
      player.position++;

      // ç©å®¶ç¶“éçš„æ ¼å­éƒ½æ¨™è¨˜ç‚ºå·²è¨ªå•ï¼ˆç§»é™¤è¿·éœ§ï¼‰
      visitedCells.add(player.position);

      renderBoard();
      renderPlayersInfo();
      currentStep++;
    } else {
      clearInterval(moveInterval);

      // æª¢æŸ¥æ˜¯å¦è¸©åˆ°è›‡æˆ–æ¢¯å­
      if (gameConfig.snakeLadderMode) {
        const snakeLadder = checkSnakeLadder(player.position);
        if (snakeLadder) {
          // é¡¯ç¤ºè›‡æˆ–æ¢¯å­è¨Šæ¯ï¼ˆç­‰å¾…ç©å®¶æŒ‰ç¢ºèªï¼‰
          showSnakeLadderMessage(snakeLadder);
          return;
        }
      }

      // æª¢æŸ¥æ˜¯å¦åˆ°é”çµ‚é»
      if (player.position >= gameConfig.cellCount - 1) {
        setTimeout(() => showResults(), 1000);
      } else {
        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»å‹™
        const cell = board[player.position];
        if (cell.type === 'task') {
          // æŠ½å–ä¸€å€‹æ–°ä»»å‹™
          const task = getRandomTask();
          setTimeout(() => showTask(task), 500);
        } else {
          setTimeout(() => nextTurn(), 1000);
        }
      }
    }
  }, 300);
}

// æª¢æŸ¥ç•¶å‰ä½ç½®æ˜¯å¦æœ‰è›‡æˆ–æ¢¯å­
function checkSnakeLadder(position) {
  // æª¢æŸ¥æ¢¯å­
  for (const ladder of gameConfig.ladders || []) {
    if (ladder.from === position) {
      return { type: 'ladder', from: ladder.from, to: ladder.to };
    }
  }

  // æª¢æŸ¥è›‡
  for (const snake of gameConfig.snakes || []) {
    if (snake.from === position) {
      return { type: 'snake', from: snake.from, to: snake.to };
    }
  }

  return null;
}

// å„²å­˜ç•¶å‰è›‡æ¢¯è³‡è¨Š
let currentSnakeLadder = null;

// é¡¯ç¤ºè›‡æˆ–æ¢¯å­è¨Šæ¯
function showSnakeLadderMessage(snakeLadder) {
  // å„²å­˜è›‡æ¢¯è³‡è¨Šä¾›ç¢ºèªæŒ‰éˆ•ä½¿ç”¨
  currentSnakeLadder = snakeLadder;

  const player = players[currentPlayerIndex];
  const modal = document.getElementById('snakeLadderModal');
  const header = document.getElementById('snakeLadderHeader');
  const content = document.getElementById('snakeLadderContent');

  // è¨­å®šè¨Šæ¯å…§å®¹
  if (snakeLadder.type === 'ladder') {
    header.innerHTML = 'ğŸªœ æ¢¯å­';
    header.style.background = 'linear-gradient(135deg, #11998e, #38ef7d)';
    content.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <div style="font-size: 5em; line-height: 1; animation: bounce 0.6s ease-in-out;">ğŸªœ</div>

        <div style="text-align: center;">
          <div style="font-size: 1.4em; font-weight: bold; color: #11998e; margin-bottom: 8px;">
            ${player.name} è¸©åˆ°æ¢¯å­ï¼
          </div>
          <div style="font-size: 0.95em; color: #666; opacity: 0.9;">
            ğŸ‰ å¿«é€Ÿå‰é€²ï¼
          </div>
        </div>

        <div style="
          background: linear-gradient(135deg, rgba(17,153,142,0.1), rgba(56,239,125,0.1));
          padding: 20px 30px;
          border-radius: 15px;
          border: 2px solid rgba(17,153,142,0.3);
          width: 100%;
          max-width: 350px;
        ">
          <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">å¾æ ¼å­</div>
              <div style="
                font-size: 2.5em;
                font-weight: bold;
                color: #667eea;
                background: white;
                width: 70px;
                height: 70px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
              ">${snakeLadder.from}</div>
            </div>

            <div style="font-size: 2em; color: #11998e; animation: slideRight 0.8s ease-in-out infinite;">
              âœ
            </div>

            <div style="text-align: center;">
              <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">å‰é€²åˆ°</div>
              <div style="
                font-size: 2.5em;
                font-weight: bold;
                color: white;
                background: linear-gradient(135deg, #11998e, #38ef7d);
                width: 70px;
                height: 70px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 6px 15px rgba(17,153,142,0.4);
              ">${snakeLadder.to}</div>
            </div>
          </div>
        </div>

        <button onclick="confirmSnakeLadderMove()" style="
          padding: 15px 40px;
          background: linear-gradient(135deg, #11998e, #38ef7d);
          border: none;
          border-radius: 12px;
          color: white;
          font-size: 1.1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 4px 15px rgba(17,153,142,0.3);
          margin-top: 10px;
        " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(17,153,142,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(17,153,142,0.3)';">
          âœ“ ç¢ºèªç§»å‹•
        </button>
      </div>

      <style>
        @keyframes bounce {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-15px); }
        }
        @keyframes slideRight {
          0%, 100% { transform: translateX(0); opacity: 1; }
          50% { transform: translateX(10px); opacity: 0.6; }
        }
      </style>
    `;
  } else {
    header.innerHTML = 'ğŸ è›‡';
    header.style.background = 'linear-gradient(135deg, #f5576c, #f093fb)';
    content.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; gap: 20px;">
        <div style="font-size: 5em; line-height: 1; animation: shake 0.5s ease-in-out;">ğŸ</div>

        <div style="text-align: center;">
          <div style="font-size: 1.4em; font-weight: bold; color: #f5576c; margin-bottom: 8px;">
            ${player.name} è¸©åˆ°è›‡ï¼
          </div>
          <div style="font-size: 0.95em; color: #666; opacity: 0.9;">
            ğŸ˜­ å¾Œé€€æ‡²ç½°...
          </div>
        </div>

        <div style="
          background: linear-gradient(135deg, rgba(245,87,108,0.1), rgba(240,147,251,0.1));
          padding: 20px 30px;
          border-radius: 15px;
          border: 2px solid rgba(245,87,108,0.3);
          width: 100%;
          max-width: 350px;
        ">
          <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
            <div style="text-align: center;">
              <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">å¾æ ¼å­</div>
              <div style="
                font-size: 2.5em;
                font-weight: bold;
                color: #667eea;
                background: white;
                width: 70px;
                height: 70px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.1);
              ">${snakeLadder.from}</div>
            </div>

            <div style="font-size: 2em; color: #f5576c; animation: slideLeft 0.8s ease-in-out infinite;">
              â¬…
            </div>

            <div style="text-align: center;">
              <div style="font-size: 0.85em; color: #999; margin-bottom: 5px;">é€€å›åˆ°</div>
              <div style="
                font-size: 2.5em;
                font-weight: bold;
                color: white;
                background: linear-gradient(135deg, #f5576c, #f093fb);
                width: 70px;
                height: 70px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                box-shadow: 0 6px 15px rgba(245,87,108,0.4);
              ">${snakeLadder.to}</div>
            </div>
          </div>
        </div>

        <button onclick="confirmSnakeLadderMove()" style="
          padding: 15px 40px;
          background: linear-gradient(135deg, #f5576c, #f093fb);
          border: none;
          border-radius: 12px;
          color: white;
          font-size: 1.1em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          box-shadow: 0 4px 15px rgba(245,87,108,0.3);
          margin-top: 10px;
        " onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 20px rgba(245,87,108,0.5)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(245,87,108,0.3)';">
          âœ“ ç¢ºèªç§»å‹•
        </button>
      </div>

      <style>
        @keyframes shake {
          0%, 100% { transform: rotate(0deg); }
          25% { transform: rotate(-10deg); }
          75% { transform: rotate(10deg); }
        }
        @keyframes slideLeft {
          0%, 100% { transform: translateX(0); opacity: 1; }
          50% { transform: translateX(-10px); opacity: 0.6; }
        }
      </style>
    `;
  }

  // é¡¯ç¤ºå½ˆçª—
  modal.classList.add('active');
}

// ç¢ºèªè›‡æ¢¯ç§»å‹•
function confirmSnakeLadderMove() {
  if (!currentSnakeLadder) return;

  const player = players[currentPlayerIndex];

  // ç§»å‹•åˆ°ç›®æ¨™ä½ç½®
  player.position = currentSnakeLadder.to;
  visitedCells.add(player.position);
  renderBoard();
  renderPlayersInfo();

  // æ¸…é™¤è›‡æ¢¯è³‡è¨Š
  currentSnakeLadder = null;

  // ç§»å‹•å¾Œç¹¼çºŒéŠæˆ²æµç¨‹
  continueAfterSnakeLadder();
}

// è›‡æ¢¯ç§»å‹•å¾Œç¹¼çºŒéŠæˆ²æµç¨‹
function continueAfterSnakeLadder() {
  const player = players[currentPlayerIndex];

  // é—œé–‰è›‡æ¢¯å½ˆçª—
  document.getElementById('snakeLadderModal').classList.remove('active');

  // æª¢æŸ¥æ˜¯å¦åˆ°é”çµ‚é»
  if (player.position >= gameConfig.cellCount - 1) {
    setTimeout(() => showResults(), 1000);
  } else {
    // æª¢æŸ¥æ˜¯å¦æœ‰ä»»å‹™
    const cell = board[player.position];
    if (cell.type === 'task') {
      // æŠ½å–ä¸€å€‹æ–°ä»»å‹™
      const task = getRandomTask();
      setTimeout(() => showTask(task), 500);
    } else {
      setTimeout(() => nextTurn(), 1000);
    }
  }
}

// å¾ä»»å‹™æ± ä¸­éš¨æ©ŸæŠ½å–ä¸€å€‹æœªä½¿ç”¨çš„ä»»å‹™
function getRandomTask() {
  // å¦‚æœæ‰€æœ‰ä»»å‹™éƒ½ç”¨éäº†ï¼Œé‡ç½®ä»»å‹™æ± 
  if (availableTasks.length === 0) {
    availableTasks = [...gameConfig.tasks];
    usedTasks = new Set();
  }

  // éš¨æ©Ÿé¸æ“‡ä¸€å€‹ä»»å‹™
  const randomIndex = Math.floor(Math.random() * availableTasks.length);
  const task = availableTasks[randomIndex];

  // å¾å¯ç”¨ä»»å‹™ä¸­ç§»é™¤
  availableTasks.splice(randomIndex, 1);
  usedTasks.add(task);

  return task;
}

let currentTask = null; // å„²å­˜ç•¶å‰ä»»å‹™ç‰©ä»¶

function showTask(task) {
  const player = players[currentPlayerIndex];
  currentTask = task; // ä¿å­˜ä»»å‹™ç‰©ä»¶

  // é‡ç½®å¡ç‰‡ç‹€æ…‹
  const card = document.getElementById('taskCard');
  card.classList.remove('flipped');

  // è¨­å®šä»»å‹™å…§å®¹
  document.getElementById('taskText').innerHTML = `
    <strong>${player.name} çš„ä»»å‹™ï¼š</strong>
    <div style="margin-top: 15px; font-size: 1.15em;">${task.text}</div>
    <div style="margin-top: 10px; font-size: 0.9em; color: rgba(255,255,255,0.9);">å®Œæˆå¯å¾— ${task.points} åˆ†</div>
  `;

  // éš±è—æŒ‰éˆ•
  document.getElementById('taskButtons').style.display = 'none';

  // é¡¯ç¤ºå½ˆçª—
  document.getElementById('taskModal').classList.add('active');
}

// ç¿»ç‰Œå‡½æ•¸
function flipCard() {
  const card = document.getElementById('taskCard');
  card.classList.add('flipped');

  // ç¿»ç‰Œå¾Œé¡¯ç¤ºæŒ‰éˆ•
  setTimeout(() => {
    document.getElementById('taskButtons').style.display = 'flex';
  }, 400);
}

function completeTask(success) {
  document.getElementById('taskModal').classList.remove('active');

  if (success && currentTask) {
    // ä½¿ç”¨ç•¶å‰ä»»å‹™çš„åˆ†æ•¸
    players[currentPlayerIndex].score += currentTask.points;
    renderPlayersInfo();
  }

  currentTask = null; // æ¸…ç©ºç•¶å‰ä»»å‹™
  setTimeout(() => nextTurn(), 500);
}

function nextTurn() {
  currentPlayerIndex = (currentPlayerIndex + 1) % players.length;
  renderPlayersInfo();
  renderBoard(); // é‡æ–°æ¸²æŸ“æ£‹ç›¤ï¼Œæ›´æ–°ç•¶å‰ç©å®¶çš„ç™¼å…‰æ•ˆæœ
  updateTurnInfo();

  // æ²å‹•åˆ°ç•¶å‰ç©å®¶ä½ç½®
  setTimeout(() => {
    scrollToCurrentPlayer();
  }, 100);

  // å•Ÿç”¨éª°å­é»æ“Š
  const diceDisplay = document.getElementById('diceDisplay');
  diceDisplay.classList.remove('disabled');
  isRolling = false;
}

// ========== çµæœé¡¯ç¤º ==========
function showResults() {
  document.getElementById('gamePage').style.display = 'none';
  document.getElementById('resultPage').style.display = 'block';

  // æ’åºç©å®¶
  const sortedPlayers = [...players].sort((a, b) => b.score - a.score);

  // é¡¯ç¤ºå† è»
  document.getElementById('winnerText').textContent = `ğŸ‰ ${sortedPlayers[0].name} ç²å‹ï¼ ğŸ‰`;

  // é¡¯ç¤ºè¨ˆåˆ†æ¿
  const scoreboard = document.getElementById('scoreboard');
  scoreboard.innerHTML = '';

  sortedPlayers.forEach((player, index) => {
    const item = document.createElement('div');
    item.className = 'score-item';
    if (index === 0) item.classList.add('rank1');
    else if (index === 1) item.classList.add('rank2');
    else if (index === 2) item.classList.add('rank3');

    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
    const medal = medals[index] || 'ğŸ…';

    item.innerHTML = `
      <div class="score-rank">${medal}</div>
      <div class="score-player">
        <div class="score-player-icon" style="background: ${player.color}"></div>
        <div class="score-player-name">${player.name}</div>
      </div>
      <div class="score-points">${player.score} åˆ†</div>
    `;
    scoreboard.appendChild(item);
  });
}

// ========== åŒ¯å‡º/åŒ¯å…¥è¨­å®š ==========
function exportSettings() {
  // æ”¶é›†ç•¶å‰æ‰€æœ‰è¨­å®š
  const settings = {
    version: '1.0',
    cellCount: parseInt(document.getElementById('cellCount').value),
    playerCount: parseInt(document.getElementById('playerCount').value),
    taskCount: parseInt(document.getElementById('taskCount').value),
    taskSuccessScore: parseInt(document.getElementById('taskSuccessScore').value),
    hiddenMode: document.getElementById('hiddenMode').checked,
    snakeLadderMode: document.getElementById('snakeLadderMode').checked,
    tasks: [],
    ladders: [],
    snakes: []
  };

  // æ”¶é›†ä»»å‹™
  const taskCount = parseInt(document.getElementById('taskCount').value);
  for (let i = 0; i < taskCount; i++) {
    const taskInput = document.getElementById(`task${i}`);
    const pointsInput = document.getElementById(`taskPoints${i}`);
    if (taskInput) {
      settings.tasks.push({
        text: taskInput.value.trim(),
        points: pointsInput ? parseInt(pointsInput.value) || 10 : 10
      });
    }
  }

  // æ”¶é›†è›‡æ¢¯è¨­å®š
  if (settings.snakeLadderMode) {
    const ladderCount = parseInt(document.getElementById('ladderCount').value) || 0;
    const snakeCount = parseInt(document.getElementById('snakeCount').value) || 0;

    // æ”¶é›†æ¢¯å­
    for (let i = 0; i < ladderCount; i++) {
      const fromInput = document.getElementById(`ladder${i}From`);
      const toInput = document.getElementById(`ladder${i}To`);
      if (fromInput && toInput) {
        settings.ladders.push({
          from: parseInt(fromInput.value),
          to: parseInt(toInput.value)
        });
      }
    }

    // æ”¶é›†è›‡
    for (let i = 0; i < snakeCount; i++) {
      const fromInput = document.getElementById(`snake${i}From`);
      const toInput = document.getElementById(`snake${i}To`);
      if (fromInput && toInput) {
        settings.snakes.push({
          from: parseInt(fromInput.value),
          to: parseInt(toInput.value)
        });
      }
    }
  }

  // ç”¢ç”Ÿ JSON æª”æ¡ˆ
  const dataStr = JSON.stringify(settings, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });

  // å»ºç«‹ä¸‹è¼‰é€£çµ
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `å¤§å¯Œç¿éŠæˆ²è¨­å®š_${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);

  alert('è¨­å®šå·²åŒ¯å‡ºï¼');
}

function importSettings(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const settings = JSON.parse(e.target.result);

      // é©—è­‰è¨­å®šæª”æ ¼å¼
      if (!settings.version || !settings.tasks) {
        alert('è¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼');
        return;
      }

      // å¥—ç”¨è¨­å®š
      if (settings.cellCount) document.getElementById('cellCount').value = settings.cellCount;
      if (settings.playerCount) {
        document.getElementById('playerCount').value = settings.playerCount;
        generatePlayerInputs();
      }
      if (settings.taskCount) document.getElementById('taskCount').value = settings.taskCount;
      if (settings.taskSuccessScore) document.getElementById('taskSuccessScore').value = settings.taskSuccessScore;
      if (settings.hiddenMode !== undefined) document.getElementById('hiddenMode').checked = settings.hiddenMode;

      // å¥—ç”¨è›‡æ¢¯æ¨¡å¼è¨­å®š
      if (settings.snakeLadderMode !== undefined) {
        document.getElementById('snakeLadderMode').checked = settings.snakeLadderMode;
        toggleSnakeLadderSettings();
      }

      // ç”¢ç”Ÿä»»å‹™æ¬„ä½ä¸¦å¡«å…¥ä»»å‹™
      generateTaskInputs();

      // å¡«å…¥ä»»å‹™å…§å®¹å’Œè›‡æ¢¯è¨­å®š
      setTimeout(() => {
        // å¡«å…¥ä»»å‹™
        settings.tasks.forEach((task, i) => {
          const taskInput = document.getElementById(`task${i}`);
          const pointsInput = document.getElementById(`taskPoints${i}`);
          if (taskInput) {
            // å…¼å®¹èˆŠæ ¼å¼ï¼ˆç´”å­—ä¸²ï¼‰å’Œæ–°æ ¼å¼ï¼ˆç‰©ä»¶ï¼‰
            if (typeof task === 'string') {
              taskInput.value = task;
              if (pointsInput) pointsInput.value = 10;
            } else {
              taskInput.value = task.text || '';
              if (pointsInput) pointsInput.value = task.points || 10;
            }
          }
        });

        // å¡«å…¥è›‡æ¢¯è¨­å®š
        if (settings.snakeLadderMode && (settings.ladders || settings.snakes)) {
          const ladderCount = settings.ladders ? settings.ladders.length : 0;
          const snakeCount = settings.snakes ? settings.snakes.length : 0;

          if (ladderCount > 0) document.getElementById('ladderCount').value = ladderCount;
          if (snakeCount > 0) document.getElementById('snakeCount').value = snakeCount;

          // ç”¢ç”Ÿè›‡æ¢¯è¼¸å…¥æ¬„ä½
          generateSnakeLadderInputs();

          // ç¨å¾Œå¡«å…¥è›‡æ¢¯æ•¸å€¼
          setTimeout(() => {
            // å¡«å…¥æ¢¯å­
            if (settings.ladders) {
              settings.ladders.forEach((ladder, i) => {
                const fromInput = document.getElementById(`ladder${i}From`);
                const toInput = document.getElementById(`ladder${i}To`);
                if (fromInput) fromInput.value = ladder.from;
                if (toInput) toInput.value = ladder.to;
              });
            }

            // å¡«å…¥è›‡
            if (settings.snakes) {
              settings.snakes.forEach((snake, i) => {
                const fromInput = document.getElementById(`snake${i}From`);
                const toInput = document.getElementById(`snake${i}To`);
                if (fromInput) fromInput.value = snake.from;
                if (toInput) toInput.value = snake.to;
              });
            }
          }, 100);
        }
      }, 100);

      alert('è¨­å®šå·²æˆåŠŸåŒ¯å…¥ï¼');
    } catch (error) {
      alert('åŒ¯å…¥å¤±æ•—ï¼šè¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼\n' + error.message);
    }
  };
  reader.readAsText(file);

  // é‡ç½®æª”æ¡ˆè¼¸å…¥ï¼Œå…è¨±é‡è¤‡åŒ¯å…¥ç›¸åŒæª”æ¡ˆ
  event.target.value = '';
}

// ========== å´é‚Šæ¬„æ§åˆ¶ ==========
function toggleSidebar(forceClose = null) {
  const sidebar = document.getElementById('diceControlSidebar');
  const overlay = document.getElementById('sidebarOverlay');
  const floatingBtn = document.querySelector('.floating-button');

  // å¦‚æœæ˜ç¢ºæŒ‡å®šè¦é—œé–‰
  if (forceClose === false) {
    sidebar.classList.remove('open');
    overlay.classList.remove('active');
    floatingBtn.classList.remove('hidden');
    return;
  }

  sidebar.classList.toggle('open');
  overlay.classList.toggle('active');

  if (sidebar.classList.contains('open')) {
    floatingBtn.classList.add('hidden');

    // æ‰“é–‹å´é‚Šæ¬„æ™‚ï¼Œç­‰å¾…æ»‘å‡ºå‹•ç•«å®Œæˆå¾Œå†æ»¾å‹•åˆ°ç•¶å‰ç©å®¶ä½ç½®
    setTimeout(() => {
      const scrollContainer = document.querySelector('.dice-control-scrollable');
      const activeCard = document.querySelector('.player-card.active');

      if (scrollContainer && activeCard) {
        // ä½¿ç”¨ scrollIntoView è®“ç•¶å‰ç©å®¶å¡ç‰‡é¡¯ç¤ºåœ¨å¯è¦‹å€åŸŸ
        activeCard.scrollIntoView({
          behavior: 'smooth',
          block: 'center',
          inline: 'nearest'
        });
      }
    }, 350); // ç­‰å¾…å´é‚Šæ¬„æ»‘å‡ºå‹•ç•«å®Œæˆï¼ˆå´é‚Šæ¬„å‹•ç•«æ˜¯ 0.3sï¼‰
  } else {
    floatingBtn.classList.remove('hidden');
  }
}

// ========== åˆå§‹åŒ– ==========
window.onload = function() {
  // è¼‰å…¥ä¸Šæ¬¡å„²å­˜çš„ä»»å‹™æ•¸é‡
  const savedTaskCount = localStorage.getItem('monopolyGameTaskCount');
  if (savedTaskCount) {
    document.getElementById('taskCount').value = savedTaskCount;
  }

  generatePlayerInputs();
  generateTaskInputs();
};

// è¦–çª—å¤§å°æ”¹è®Šæ™‚é‡æ–°æ¸²æŸ“æ£‹ç›¤ï¼ˆè™•ç†æ‰‹æ©Ÿæ—‹è½‰ç­‰æƒ…æ³ï¼‰
let resizeTimeout;
window.addEventListener('resize', function() {
  // ä½¿ç”¨é˜²æŠ–ï¼Œé¿å…é »ç¹é‡æ–°æ¸²æŸ“
  clearTimeout(resizeTimeout);
  resizeTimeout = setTimeout(() => {
    // åªåœ¨éŠæˆ²é€²è¡Œä¸­æ‰é‡æ–°æ¸²æŸ“
    if (document.getElementById('gamePage').style.display !== 'none') {
      renderBoard();
    }
  }, 300);
});

// ç§˜æŠ€ï¼šCtrl/Cmd + K å«å‡ºæŒ‡å®šéª°å­åŠŸèƒ½
let cheatModeActive = false;
let selectedCheatDice = null;

window.addEventListener('keydown', function(e) {
  // Ctrl+K (Windows/Linux) æˆ– Cmd+K (Mac)
  if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
    e.preventDefault();

    // åªåœ¨éŠæˆ²é€²è¡Œä¸­æ‰èƒ½ä½¿ç”¨
    if (document.getElementById('gamePage').style.display === 'none') {
      return;
    }

    cheatModeActive = !cheatModeActive;

    if (cheatModeActive) {
      showCheatDicePanel();
    } else {
      hideCheatDicePanel();
    }
  }
});

function showCheatDicePanel() {
  // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
  let panel = document.getElementById('cheatDicePanel');
  if (panel) {
    panel.style.display = 'block';
    const overlay = document.getElementById('cheatDiceOverlay');
    if (overlay) overlay.style.display = 'block';
    return;
  }

  // å‰µå»ºç§˜æŠ€é¢æ¿
  panel = document.createElement('div');
  panel.id = 'cheatDicePanel';
  panel.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
    padding: 35px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.1);
    z-index: 10000;
    color: white;
    min-width: 380px;
  `;

  panel.innerHTML = `
    <div style="text-align: center;">
      <div style="font-size: 3em; margin-bottom: 10px;">ğŸ®</div>
      <h3 style="margin: 0 0 8px 0; color: #FFD700; font-size: 1.5em; font-weight: 600;">æ¸¬è©¦æ¨¡å¼</h3>
      <p style="font-size: 0.95em; opacity: 0.85; margin: 0 0 25px 0;">é¸æ“‡éª°å­é»æ•¸å¾ŒæŒ‰ç¢ºèªåŸ·è¡Œ</p>

      <div id="cheatDiceSelection" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 25px;">
        ${[1,2,3,4,5,6].map(num => `
          <button onclick="selectCheatDice(${num})" data-dice="${num}" class="cheat-dice-btn" style="
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            background: rgba(255,255,255,0.15);
            border: 3px solid rgba(255,255,255,0.25);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
          " onmouseover="if(!this.classList.contains('selected')) {this.style.background='rgba(255,255,255,0.25)'; this.style.transform='scale(1.05)';}" onmouseout="if(!this.classList.contains('selected')) {this.style.background='rgba(255,255,255,0.15)'; this.style.transform='scale(1)';}">
            ${num}
          </button>
        `).join('')}
      </div>

      <div id="cheatSelectedDisplay" style="min-height: 40px; margin-bottom: 20px; font-size: 1.1em; color: #FFD700; font-weight: 500; opacity: 0;">
        å·²é¸æ“‡ï¼š<span id="cheatSelectedNumber" style="font-size: 1.5em; font-weight: bold;">-</span>
      </div>

      <div style="display: flex; gap: 12px; justify-content: center;">
        <button id="cheatConfirmBtn" onclick="confirmCheatDice()" disabled style="
          padding: 14px 32px;
          background: linear-gradient(135deg, #11998e, #38ef7d);
          border: none;
          border-radius: 10px;
          color: white;
          font-size: 1.05em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          opacity: 0.5;
          flex: 1;
          max-width: 150px;
        ">âœ“ ç¢ºèª</button>

        <button onclick="hideCheatDicePanel()" style="
          padding: 14px 32px;
          background: rgba(255,255,255,0.15);
          border: 2px solid rgba(255,255,255,0.3);
          border-radius: 10px;
          color: white;
          font-size: 1.05em;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          flex: 1;
          max-width: 150px;
        " onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">âœ• é—œé–‰</button>
      </div>

      <div style="margin-top: 20px; font-size: 0.85em; opacity: 0.6;">
        å¿«æ·éµï¼šCtrl/Cmd + K
      </div>
    </div>
  `;

  // æ·»åŠ èƒŒæ™¯é®ç½©
  const overlay = document.createElement('div');
  overlay.id = 'cheatDiceOverlay';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 9999;
    backdrop-filter: blur(5px);
  `;
  overlay.onclick = hideCheatDicePanel;

  document.body.appendChild(overlay);
  document.body.appendChild(panel);
}

function selectCheatDice(number) {
  selectedCheatDice = number;

  // æ›´æ–°æ‰€æœ‰æŒ‰éˆ•çš„æ¨£å¼
  const allBtns = document.querySelectorAll('.cheat-dice-btn');
  allBtns.forEach(btn => {
    const btnNum = parseInt(btn.getAttribute('data-dice'));
    if (btnNum === number) {
      btn.classList.add('selected');
      btn.style.background = 'linear-gradient(135deg, #11998e, #38ef7d)';
      btn.style.border = '3px solid #11998e';
      btn.style.transform = 'scale(1.1)';
      btn.style.boxShadow = '0 0 20px rgba(17, 153, 142, 0.5)';
    } else {
      btn.classList.remove('selected');
      btn.style.background = 'rgba(255,255,255,0.15)';
      btn.style.border = '3px solid rgba(255,255,255,0.25)';
      btn.style.transform = 'scale(1)';
      btn.style.boxShadow = 'none';
    }
  });

  // é¡¯ç¤ºé¸æ“‡çš„æ•¸å­—
  const display = document.getElementById('cheatSelectedDisplay');
  const numberSpan = document.getElementById('cheatSelectedNumber');
  display.style.opacity = '1';
  numberSpan.textContent = number;

  // å•Ÿç”¨ç¢ºèªæŒ‰éˆ•
  const confirmBtn = document.getElementById('cheatConfirmBtn');
  confirmBtn.disabled = false;
  confirmBtn.style.opacity = '1';
  confirmBtn.style.cursor = 'pointer';
  confirmBtn.onmouseover = function() {
    this.style.transform = 'scale(1.05)';
    this.style.boxShadow = '0 5px 15px rgba(17, 153, 142, 0.4)';
  };
  confirmBtn.onmouseout = function() {
    this.style.transform = 'scale(1)';
    this.style.boxShadow = 'none';
  };
}

function confirmCheatDice() {
  if (selectedCheatDice === null) return;

  const diceValue = selectedCheatDice;

  // é—œé–‰å´é‚Šæ¬„ï¼ˆè·Ÿæ­£å¸¸æ“²éª°å­ä¸€æ¨£ï¼‰
  toggleSidebar(false);

  // æ›´æ–°éª°å­é¡¯ç¤º
  const diceDisplay = document.getElementById('diceDisplay');
  const dice = createDice(diceValue);
  diceDisplay.innerHTML = '';
  diceDisplay.appendChild(dice);

  // ç¦ç”¨éª°å­é»æ“Š
  diceDisplay.classList.add('disabled');
  isRolling = true;

  // åŸ·è¡Œç§»å‹•
  movePlayer(diceValue);

  // é—œé–‰ç§˜æŠ€é¢æ¿
  hideCheatDicePanel();

  // é‡ç½®é¸æ“‡
  selectedCheatDice = null;
}

function hideCheatDicePanel() {
  cheatModeActive = false;
  selectedCheatDice = null;
  const panel = document.getElementById('cheatDicePanel');
  const overlay = document.getElementById('cheatDiceOverlay');
  if (panel) panel.style.display = 'none';
  if (overlay) overlay.style.display = 'none';
}
</script>

</body>
</html>
